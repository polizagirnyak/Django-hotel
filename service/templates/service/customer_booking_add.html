{% extends 'service/base.html' %}
{% load static %}

{% block title %}Новая запись на услугу - {{ customer.get_full_name }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-md-10 col-lg-8 mx-auto">
            <div class="card shadow">
                <div class="card-header bg-white py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Новая запись на услугу</h5>
                        <a href="{% url 'customer_service_bookings' customer.pk %}" class="btn btn-sm btn-outline-secondary">
                            <i class="fas fa-arrow-left"></i> Назад
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Информация о клиенте -->
                    <div class="alert alert-info mb-4">
                        <div class="d-flex align-items-center">
                            <div class="me-3">
                                <i class="fas fa-user-circle fa-2x"></i>
                            </div>
                            <div class="flex-grow-1">
                                <h6 class="alert-heading mb-1">Клиент: {{ customer.get_full_name }}</h6>
                                <p class="mb-0">
                                    <span class="me-3">
                                        <i class="fas fa-phone"></i> {{ customer.phone }}
                                    </span>
                                    <span>
                                        <i class="fas fa-envelope"></i> {{ customer.email|default:"—" }}
                                    </span>
                                </p>
                            </div>
                            <div>
                                <a href="{% url 'customer_detail' customer.pk %}" class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-external-link-alt"></i> Профиль
                                </a>
                            </div>
                        </div>
                    </div>

                    <!-- Форма записи -->
                    <form method="post" novalidate>
                        {% csrf_token %}

                        {% if form.non_field_errors %}
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-circle me-2"></i>
                            {% for error in form.non_field_errors %}
                            {{ error }}
                            {% endfor %}
                        </div>
                        {% endif %}

                        <div class="row">
                            <!-- Выбор услуги -->
                            <div class="col-md-6 mb-4">
                                <div class="mb-3">
                                    <label for="{{ form.service.id_for_label }}" class="form-label fw-semibold">
                                        <i class="fas fa-spa me-2"></i>Услуга *
                                    </label>
                                    {{ form.service }}
                                    {% if form.service.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.service.errors }}
                                    </div>
                                    {% endif %}
                                </div>

                                <!-- Информация об услуге -->
                                <div id="service-info" class="card border-primary" style="display: none;">
                                    <div class="card-body p-3">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div>
                                                <h6 class="card-title mb-1" id="service-name"></h6>
                                                <p class="card-text text-muted small mb-2" id="service-description"></p>
                                                <div class="d-flex align-items-center">
                                                    <span class="badge bg-info me-2" id="service-duration"></span>
                                                    <span class="badge bg-secondary" id="service-capacity"></span>
                                                </div>
                                            </div>
                                            <div class="text-end">
                                                <div class="text-success fw-bold fs-5" id="service-price"></div>
                                                <small class="text-muted">за 1 чел.</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Дата и время -->
                            <div class="col-md-6 mb-4">
                                <div class="row">
                                    <div class="col-12 mb-3">
                                        <label for="{{ form.booking_date.id_for_label }}" class="form-label fw-semibold">
                                            <i class="fas fa-calendar-alt me-2"></i>Дата записи *
                                        </label>
                                        {{ form.booking_date }}
                                        {% if form.booking_date.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.booking_date.errors }}
                                        </div>
                                        {% endif %}
                                    </div>

                                    <div class="col-12 mb-3">
                                        <label for="{{ form.start_time.id_for_label }}" class="form-label fw-semibold">
                                            <i class="fas fa-clock me-2"></i>Время начала *
                                        </label>
                                        {{ form.start_time }}
                                        {% if form.start_time.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.start_time.errors }}
                                        </div>
                                        {% endif %}
                                        <div id="end-time" class="mt-2 small text-muted" style="display: none;">
                                            <i class="fas fa-hourglass-end me-1"></i>
                                            Окончание: <span id="end-time-value" class="fw-semibold"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <!-- Количество участников и статус -->
                            <div class="col-md-6 mb-4">
                                <div class="mb-3">
                                    <label for="{{ form.participants.id_for_label }}" class="form-label fw-semibold">
                                        <i class="fas fa-users me-2"></i>Количество участников
                                    </label>
                                    <div class="input-group">
                                        {{ form.participants }}
                                        <span class="input-group-text">
                                            чел.
                                        </span>
                                    </div>
                                    {% if form.participants.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.participants.errors }}
                                    </div>
                                    {% endif %}
                                    <small class="form-text text-muted" id="max-capacity-info">
                                        Максимально: <span id="max-capacity" class="fw-semibold">1</span> человек
                                    </small>
                                </div>
                            </div>

                            <div class="col-md-6 mb-4">
                                <div class="mb-3">
                                    <label for="{{ form.status.id_for_label }}" class="form-label fw-semibold">
                                        <i class="fas fa-flag me-2"></i>Статус записи *
                                    </label>
                                    {{ form.status }}
                                    {% if form.status.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.status.errors }}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Пожелания и примечания -->
                        <div class="row">
                            <div class="col-md-6 mb-4">
                                <div class="mb-3">
                                    <label for="{{ form.special_requests.id_for_label }}" class="form-label fw-semibold">
                                        <i class="fas fa-comment-medical me-2"></i>Особые пожелания клиента
                                    </label>
                                    {{ form.special_requests }}
                                    {% if form.special_requests.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.special_requests.errors }}
                                    </div>
                                    {% endif %}
                                    <small class="form-text text-muted">
                                        Предпочтения и пожелания клиента к услуге
                                    </small>
                                </div>
                            </div>

                            <div class="col-md-6 mb-4">
                                <div class="mb-3">
                                    <label for="{{ form.notes.id_for_label }}" class="form-label fw-semibold">
                                        <i class="fas fa-sticky-note me-2"></i>Примечания администратора
                                    </label>
                                    {{ form.notes }}
                                    {% if form.notes.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.notes.errors }}
                                    </div>
                                    {% endif %}
                                    <small class="form-text text-muted">
                                        Внутренние заметки для администрации отеля
                                    </small>
                                </div>
                            </div>
                        </div>

                        <!-- Итоговая стоимость -->
                        <div class="alert alert-success mb-4">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="alert-heading mb-1">
                                        <i class="fas fa-calculator me-2"></i>Итоговая стоимость
                                    </h6>
                                    <p class="mb-0">
                                        <small class="text-muted">
                                            Рассчитывается автоматически на основе услуги и количества участников
                                        </small>
                                    </p>
                                </div>
                                <div class="text-end">
                                    <div class="fs-4 fw-bold text-success" id="total-price">0</div>
                                    <small class="text-muted">рублей</small>
                                </div>
                            </div>
                        </div>

                        <!-- Кнопки действий -->
                        <div class="d-flex justify-content-between mt-4 pt-3 border-top">
                            <a href="{% url 'customer_service_bookings' customer.pk %}" class="btn btn-secondary">
                                <i class="fas fa-times me-2"></i>Отмена
                            </a>
                            <div>
                                <button type="submit" name="save_and_new" value="true" class="btn btn-outline-primary me-2">
                                    <i class="fas fa-save me-2"></i>Сохранить и добавить еще
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-check me-2"></i>Создать запись
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .form-control, .form-select {
        border-radius: 8px;
        border: 1px solid #dee2e6;
        padding: 0.75rem;
        transition: all 0.3s ease;
    }

    .form-control:focus, .form-select:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        transform: translateY(-1px);
    }

    textarea.form-control {
        min-height: 100px;
        resize: vertical;
    }

    .alert-info {
        background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
        border-color: #90caf9;
        color: #0c5460;
        border-radius: 10px;
        border-left: 4px solid #1976d2;
    }

    .alert-success {
        background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
        border-color: #a5d6a7;
        color: #155724;
        border-radius: 10px;
        border-left: 4px solid #2e7d32;
    }

    .card.border-primary {
        border-color: #667eea !important;
        border-width: 2px;
    }

    .badge {
        font-weight: 500;
        padding: 0.35em 0.65em;
    }

    .input-group-text {
        background-color: #f8f9fa;
        border-color: #dee2e6;
    }

    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        padding: 0.75rem 1.5rem;
        font-weight: 600;
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }

    .btn-outline-primary {
        color: #667eea;
        border-color: #667eea;
        padding: 0.75rem 1.5rem;
        font-weight: 600;
    }

    .btn-outline-primary:hover {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-color: #667eea;
    }

    .form-label {
        color: #2c3e50;
        margin-bottom: 0.5rem;
    }

    .invalid-feedback {
        font-size: 0.85rem;
        margin-top: 0.25rem;
    }

    .fw-semibold {
        font-weight: 600;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Автоматически добавляем классы к полям формы
        const inputs = document.querySelectorAll('input[type="text"], input[type="number"], textarea, select');
        inputs.forEach(input => {
            input.classList.add('form-control');
        });

        // Данные об услугах (загружаются из Django template)
        const serviceData = {
            {% for service in form.fields.service.queryset %}
            {{ service.id }}: {
                name: "{{ service.name|escapejs }}",
                description: "{{ service.short_description|escapejs }}",
                price: {{ service.price }},
                duration: {{ service.duration }},
                max_capacity: {{ service.max_capacity }}
            },
            {% endfor %}
        };

        // Элементы DOM
        const serviceSelect = document.getElementById('{{ form.service.id_for_label }}');
        const participantsInput = document.getElementById('{{ form.participants.id_for_label }}');
        const serviceInfo = document.getElementById('service-info');
        const serviceName = document.getElementById('service-name');
        const serviceDescription = document.getElementById('service-description');
        const servicePrice = document.getElementById('service-price');
        const serviceDuration = document.getElementById('service-duration');
        const serviceCapacity = document.getElementById('service-capacity');
        const maxCapacitySpan = document.getElementById('max-capacity');
        const endTimeDiv = document.getElementById('end-time');
        const endTimeValue = document.getElementById('end-time-value');
        const totalPriceSpan = document.getElementById('total-price');

        // Обновление информации об услуге
        function updateServiceInfo() {
            const serviceId = serviceSelect.value;
            if (serviceId && serviceData[serviceId]) {
                const service = serviceData[serviceId];

                serviceName.textContent = service.name;
                serviceDescription.textContent = service.description;
                servicePrice.textContent = service.price + ' руб.';

                // Форматирование длительности
                const hours = Math.floor(service.duration / 60);
                const minutes = service.duration % 60;
                let durationText = '';
                if (hours > 0) durationText += hours + ' ч ';
                if (minutes > 0) durationText += minutes + ' мин';
                serviceDuration.textContent = durationText.trim();

                serviceCapacity.textContent = 'до ' + service.max_capacity + ' чел.';
                maxCapacitySpan.textContent = service.max_capacity;

                // Установка максимального значения для участников
                participantsInput.max = service.max_capacity;
                if (participantsInput.value > service.max_capacity) {
                    participantsInput.value = service.max_capacity;
                }

                serviceInfo.style.display = 'block';
                updateTotalPrice();
                updateEndTime();
            } else {
                serviceInfo.style.display = 'none';
                totalPriceSpan.textContent = '0';
            }
        }

        // Расчет времени окончания
        function updateEndTime() {
            const serviceId = serviceSelect.value;
            const startTimeInput = document.getElementById('{{ form.start_time.id_for_label }}');

            if (serviceId && serviceData[serviceId] && startTimeInput.value) {
                const service = serviceData[serviceId];
                const startTime = startTimeInput.value;

                // Расчет времени окончания
                const [hours, minutes] = startTime.split(':').map(Number);
                let endHours = hours + Math.floor(service.duration / 60);
                let endMinutes = minutes + (service.duration % 60);

                if (endMinutes >= 60) {
                    endHours += 1;
                    endMinutes -= 60;
                }

                if (endHours >= 24) {
                    endHours -= 24;
                }

                const endTimeStr = endHours.toString().padStart(2, '0') + ':' +
                                   endMinutes.toString().padStart(2, '0');
                endTimeValue.textContent = endTimeStr;
                endTimeDiv.style.display = 'block';
            } else {
                endTimeDiv.style.display = 'none';
            }
        }

        // Расчет общей стоимости
        function updateTotalPrice() {
            const serviceId = serviceSelect.value;
            const participants = parseInt(participantsInput.value) || 1;

            if (serviceId && serviceData[serviceId]) {
                const service = serviceData[serviceId];
                const totalPrice = service.price * participants;
                totalPriceSpan.textContent = totalPrice.toLocaleString('ru-RU');
            } else {
                totalPriceSpan.textContent = '0';
            }
        }

        // Проверка доступности времени
        async function checkAvailability() {
            const serviceId = serviceSelect.value;
            const bookingDate = document.getElementById('{{ form.booking_date.id_for_label }}').value;
            const startTime = document.getElementById('{{ form.start_time.id_for_label }}').value;

            if (!serviceId || !bookingDate || !startTime) {
                return;
            }

            try {
                const response = await fetch(`/api/check-service-availability/?service_id=${serviceId}&date=${bookingDate}&start_time=${startTime}`);
                const data = await response.json();

                if (data.available) {
                    // Время доступно
                    endTimeDiv.classList.remove('text-danger');
                    endTimeDiv.classList.add('text-muted');
                    endTimeValue.textContent = data.end_time;
                } else {
                    // Время занято
                    endTimeDiv.classList.remove('text-muted');
                    endTimeDiv.classList.add('text-danger');
                    endTimeValue.textContent = data.end_time + ' (занято)';

                    // Показать предупреждение
                    if (!document.getElementById('availability-warning')) {
                        const warning = document.createElement('div');
                        warning.id = 'availability-warning';
                        warning.className = 'alert alert-warning mt-2';
                        warning.innerHTML = `
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Это время уже занято. Выберите другое время.
                        `;
                        endTimeDiv.parentElement.appendChild(warning);
                    }
                }
            } catch (error) {
                console.error('Ошибка проверки доступности:', error);
            }
        }

        // События
        serviceSelect.addEventListener('change', function() {
            updateServiceInfo();
            if (this.value) {
                checkAvailability();
            }
        });

        participantsInput.addEventListener('input', updateTotalPrice);

        const startTimeInput = document.getElementById('{{ form.start_time.id_for_label }}');
        if (startTimeInput) {
            startTimeInput.addEventListener('change', function() {
                updateEndTime();
                checkAvailability();
            });
        }

        const bookingDateInput = document.getElementById('{{ form.booking_date.id_for_label }}');
        if (bookingDateInput) {
            bookingDateInput.addEventListener('change', function() {
                if (serviceSelect.value && startTimeInput.value) {
                    checkAvailability();
                }
            });
        }

        // Инициализация
        if (serviceSelect.value) {
            updateServiceInfo();
            setTimeout(() => {
                updateEndTime();
                checkAvailability();
            }, 100);
        }
        updateTotalPrice();

        // Установка минимальной даты (сегодня)
        const today = new Date().toISOString().split('T')[0];
        if (bookingDateInput) {
            bookingDateInput.min = today;
            if (!bookingDateInput.value) {
                bookingDateInput.value = today;
            }
        }

        // Установка времени по умолчанию (ближайший час)
        if (startTimeInput && !startTimeInput.value) {
            const now = new Date();
            const nextHour = new Date(now.getTime() + 60 * 60 * 1000);
            startTimeInput.value = nextHour.getHours().toString().padStart(2, '0') + ':00';
        }

        // Установка участников по умолчанию
        if (participantsInput && !participantsInput.value) {
            participantsInput.value = 1;
        }
    });
</script>
{% endblock %}