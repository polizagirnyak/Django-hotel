{% extends 'service/base.html' %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-md-10 col-lg-8 mx-auto">
            <div class="card shadow">
                <div class="card-header bg-white py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">{{ title }}</h5>
                        <a href="{% url 'customer_service_bookings' customer.pk %}" class="btn btn-sm btn-outline-secondary">
                            <i class="fas fa-arrow-left"></i> Назад
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Информация о клиенте -->
                    <div class="alert alert-info mb-4">
                        <div class="d-flex align-items-center">
                            <div class="me-3">
                                <i class="fas fa-user-circle fa-2x"></i>
                            </div>
                            <div class="flex-grow-1">
                                <h6 class="alert-heading mb-1">Клиент: {{ customer.get_full_name }}</h6>
                                <p class="mb-0">
                                    <span class="me-3">
                                        <i class="fas fa-phone"></i> {{ customer.phone }}
                                    </span>
                                    <span>
                                        <i class="fas fa-envelope"></i> {{ customer.email|default:"—" }}
                                    </span>
                                </p>
                            </div>
                            <div>
                                <a href="{% url 'customer_detail' customer.pk %}" class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-external-link-alt"></i> Профиль
                                </a>
                            </div>
                        </div>
                    </div>

                    <!-- Форма записи -->
                    <form method="post" novalidate>
                        {% csrf_token %}

                        {% if form.non_field_errors %}
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-circle me-2"></i>
                            {% for error in form.non_field_errors %}
                            {{ error }}
                            {% endfor %}
                        </div>
                        {% endif %}

                        <!-- Скрытое поле для клиента -->
                        <input type="hidden" name="customer" value="{{ customer.pk }}">

                        <div class="row">
                            <!-- Выбор услуги -->
                            <div class="col-md-6 mb-4">
                                <div class="mb-3">
                                    <label for="{{ form.service.id_for_label }}" class="form-label fw-semibold">
                                        <i class="fas fa-spa me-2"></i>Услуга *
                                    </label>
                                    {{ form.service }}
                                    {% if form.service.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.service.errors }}
                                    </div>
                                    {% endif %}
                                    <small class="form-text text-muted">
                                        <a href="{% url 'service_list' %}" target="_blank">
                                            <i class="fas fa-external-link-alt"></i> Все услуги
                                        </a>
                                    </small>
                                </div>
                                <!-- Информация об услуге -->
                                <div id="service-info" class="card border-primary mt-3" style="display: none;">
                                    <div class="card-body p-3">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div>
                                                <h6 class="card-title mb-1" id="service-name"></h6>
                                                <p class="card-text text-muted small mb-2" id="service-description"></p>
                                                <div class="d-flex align-items-center gap-2 flex-wrap">
                                                    <span class="badge bg-info" id="service-duration"></span>
                                                    <span class="badge bg-secondary" id="service-capacity"></span>
                                                    <span class="badge bg-warning" id="service-booking-time" style="display: none;"></span>
                                                </div>
                                            </div>
                                            <div class="text-end">
                                                <div class="text-success fw-bold fs-5" id="service-price"></div>
                                                <small class="text-muted">за 1 чел.</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Дата и время -->
                            <div class="col-md-6 mb-4">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.booking_date.id_for_label }}" class="form-label fw-semibold">
                                            <i class="fas fa-calendar-alt me-2"></i>Дата записи *
                                        </label>
                                        {{ form.booking_date }}
                                        {% if form.booking_date.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.booking_date.errors }}
                                        </div>
                                        {% endif %}
                                    </div>

                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.start_time.id_for_label }}" class="form-label fw-semibold">
                                            <i class="fas fa-clock me-2"></i>Время начала *
                                        </label>
                                        {{ form.start_time }}
                                        {% if form.start_time.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.start_time.errors }}
                                        </div>
                                        {% endif %}
                                        <div id="end-time" class="mt-2 small text-muted" style="display: none;">
                                            <i class="fas fa-hourglass-end me-1"></i>
                                            Окончание: <span id="end-time-value" class="fw-semibold"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <!-- Количество участников и статус -->
                            <div class="col-md-6 mb-4">
                                <div class="mb-3">
                                    <label for="{{ form.participants.id_for_label }}" class="form-label fw-semibold">
                                        <i class="fas fa-users me-2"></i>Количество участников
                                    </label>
                                    <div class="input-group">
                                        {{ form.participants }}
                                        <span class="input-group-text">чел.</span>
                                    </div>
                                    {% if form.participants.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.participants.errors }}
                                    </div>
                                    {% endif %}
                                    <small class="form-text text-muted" id="max-capacity-info">
                                        Максимально: <span id="max-capacity" class="fw-semibold">1</span> человек
                                    </small>
                                </div>
                            </div>

                            <div class="col-md-6 mb-4">
                                <div class="mb-3">
                                    <label for="{{ form.status.id_for_label }}" class="form-label fw-semibold">
                                        <i class="fas fa-flag me-2"></i>Статус записи *
                                    </label>
                                    {{ form.status }}
                                    {% if form.status.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.status.errors }}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Информация о времени бронирования -->
                        <div id="booking-time-info" class="alert alert-warning mb-4" style="display: none;">
                            <div class="d-flex">
                                <div class="me-3">
                                    <i class="fas fa-clock"></i>
                                </div>
                                <div>
                                    <h6 class="alert-heading mb-1">Информация о бронировании</h6>
                                    <p class="mb-0" id="min-booking-time-text"></p>
                                    <p class="mb-0 mt-1 small" id="current-booking-time"></p>
                                    <p class="mb-0 mt-1 small text-success" id="available-booking-time" style="display: none;">
                                        ✓ Это время доступно для бронирования
                                    </p>
                                    <p class="mb-0 mt-1 small text-danger" id="unavailable-booking-time" style="display: none;">
                                        ⚠ Это время пока недоступно для бронирования
                                    </p>
                                </div>
                            </div>
                        </div>
                        <!-- Пожелания и примечания -->
                        <div class="row">
                            <div class="col-md-6 mb-4">
                                <div class="mb-3">
                                    <label for="{{ form.special_requests.id_for_label }}" class="form-label fw-semibold">
                                        <i class="fas fa-comment-medical me-2"></i>Особые пожелания клиента
                                    </label>
                                    {{ form.special_requests }}
                                    {% if form.special_requests.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.special_requests.errors }}
                                    </div>
                                    {% endif %}
                                    <small class="form-text text-muted">
                                        Предпочтения и пожелания клиента к услуге
                                    </small>
                                </div>
                            </div>

                            <div class="col-md-6 mb-4">
                                <div class="mb-3">
                                    <label for="{{ form.notes.id_for_label }}" class="form-label fw-semibold">
                                        <i class="fas fa-sticky-note me-2"></i>Примечания администратора
                                    </label>
                                    {{ form.notes }}
                                    {% if form.notes.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.notes.errors }}
                                    </div>
                                    {% endif %}
                                    <small class="form-text text-muted">
                                        Внутренние заметки для администрации отеля
                                    </small>
                                </div>
                            </div>
                        </div>

                        <!-- Итоговая стоимость -->
                        <div class="alert alert-success mb-4">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="alert-heading mb-1">
                                        <i class="fas fa-calculator me-2"></i>Итоговая стоимость
                                    </h6>
                                    <p class="mb-0">
                                        <small class="text-muted">
                                            Рассчитывается автоматически на основе услуги и количества участников
                                        </small>
                                    </p>
                                </div>
                                <div class="text-end">
                                    <div class="fs-4 fw-bold text-success" id="total-price">0</div>
                                    <small class="text-muted">рублей</small>
                                </div>
                            </div>
                        </div>
                        <!-- Кнопки действий -->
                        <div class="d-flex justify-content-between mt-4 pt-3 border-top">
                            <a href="{% url 'customer_service_bookings' customer.pk %}" class="btn btn-secondary">
                                <i class="fas fa-times me-2"></i>Отмена
                            </a>
                            <div>
                                <button type="submit" name="save_and_new" value="true" class="btn btn-outline-primary me-2">
                                    <i class="fas fa-save me-2"></i>Сохранить и добавить еще
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-check me-2"></i>Создать запись
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

.btn-secondary:disabled {
    background-color: #6c757d;
    border-color: #6c757d;
}

.tooltip-inner {
    max-width: 300px;
    padding: 0.5rem 0.75rem;
    background-color: #dc3545;
}

.tooltip.bs-tooltip-top .tooltip-arrow::before {
    border-top-color: #dc3545;
}
    .form-control, .form-select, textarea.form-control {
        border-radius: 8px;
        border: 1px solid #dee2e6;
        padding: 0.75rem;
        transition: all 0.3s ease;
    }

    .form-control:focus, .form-select:focus, textarea.form-control:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        transform: translateY(-1px);
    }

    .form-label {
        color: #2c3e50;
        margin-bottom: 0.5rem;
        font-weight: 500;
    }

    .fw-semibold {
        font-weight: 600;
    }

    .alert-info {
        background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
        border-color: #90caf9;
        color: #0c5460;
        border-radius: 10px;
        border-left: 4px solid #1976d2;
    }

    .alert-success {
        background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
        border-color: #a5d6a7;
        color: #155724;
        border-radius: 10px;
        border-left: 4px solid #2e7d32;
    }

    .alert-warning {
        background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
        border-color: #ffcc80;
        color: #856404;
        border-radius: 10px;
        border-left: 4px solid #ef6c00;
    }

    .card.border-primary {
        border-color: #667eea !important;
        border-width: 2px;
    }

    .badge {
        font-weight: 500;
        padding: 0.35em 0.65em;
    }

    .input-group-text {
        background-color: #f8f9fa;
        border-color: #dee2e6;
    }

    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        padding: 0.75rem 1.5rem;
        font-weight: 600;
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }

    .btn-outline-primary {
        color: #667eea;
        border-color: #667eea;
        padding: 0.75rem 1.5rem;
        font-weight: 600;
    }

    .btn-outline-primary:hover {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-color: #667eea;
    }

    .invalid-feedback {
        font-size: 0.85rem;
        margin-top: 0.25rem;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Данные об услугах
        const serviceData = {{ services_json|safe }};
    // Элементы DOM
        const serviceSelect = document.getElementById('{{ form.service.id_for_label }}');
        const participantsInput = document.getElementById('{{ form.participants.id_for_label }}');
        const bookingDateInput = document.getElementById('{{ form.booking_date.id_for_label }}');
        const startTimeInput = document.getElementById('{{ form.start_time.id_for_label }}');
        const serviceInfo = document.getElementById('service-info');

        // Функция обновления информации об услуге
        function updateServiceInfo() {
            const serviceId = serviceSelect.value;

            if (serviceId && serviceData[serviceId]) {
                const service = serviceData[serviceId];

                document.getElementById('service-name').textContent = service.name;
                document.getElementById('service-description').textContent = service.description;
                document.getElementById('service-price').textContent = service.price + ' руб.';

                // Форматирование длительности
                const hours = Math.floor(service.duration / 60);
                const minutes = service.duration % 60;
                let durationText = '';
                if (hours > 0) durationText += hours + ' ч ';
                if (minutes > 0) durationText += minutes + ' мин';
                document.getElementById('service-duration').textContent = durationText.trim();

                document.getElementById('service-capacity').textContent = 'до ' + service.max_capacity + ' чел.';
                document.getElementById('max-capacity').textContent = service.max_capacity;

                // Информация о времени бронирования
                const bookingTimeBadge = document.getElementById('service-booking-time');
                if (service.min_booking_hours > 0) {
                    bookingTimeBadge.textContent = 'Бронировать за ' + service.min_booking_hours + ' ч.';
                    bookingTimeBadge.style.display = 'inline-block';
                } else {
                    bookingTimeBadge.style.display = 'none';
                }

                // Устанавливаем максимальное значение для участников
                if (participantsInput) {
                    participantsInput.max = service.max_capacity;
                    if (participantsInput.value > service.max_capacity) {
                        participantsInput.value = service.max_capacity;
                    }
                }

                serviceInfo.style.display = 'block';
                updateTotalPrice();
                updateTimeConstraints(service);
                updateBookingTimeInfo(service);
                updateEndTime();
            } else {
                if (serviceInfo) serviceInfo.style.display = 'none';
            }
        }

        // Функция обновления ограничений по времени
        function updateTimeConstraints(service) {
            if (!service || !bookingDateInput) return;

            const now = new Date();

            if (service.min_booking_hours > 0) {
                // Рассчитываем минимальное доступное время
                const minDatetime = new Date(now.getTime() + (service.min_booking_hours * 60 * 60 * 1000));
                const minDate = minDatetime.toISOString().split('T')[0];

                // Устанавливаем минимальную дату
                bookingDateInput.min = minDate;

                // Если текущая дата меньше минимальной, устанавливаем минимальную
                if (bookingDateInput.value && bookingDateInput.value < minDate) {
                    bookingDateInput.value = minDate;
                }

                // Если выбранная дата сегодня, устанавливаем минимальное время
                if (bookingDateInput.value === minDate && startTimeInput) {
                    // Рассчитываем минимальное время
                    let minHour = minDatetime.getHours();
                    let minMinute = minDatetime.getMinutes();
    // Округляем до ближайших 15 минут в большую сторону
                    minMinute = Math.ceil(minMinute / 15) * 15;
                    if (minMinute >= 60) {
                        minHour += 1;
                        minMinute = 0;
                    }

                    const minTime = ${minHour.toString().padStart(2, '0')}:${minMinute.toString().padStart(2, '0')};
                    startTimeInput.min = minTime;

                    // Если текущее время меньше минимального, устанавливаем минимальное
                    if (startTimeInput.value && startTimeInput.value < minTime) {
                        startTimeInput.value = minTime;
                    }
                } else if (startTimeInput) {
                    // Для будущих дат снимаем ограничение
                    startTimeInput.min = '00:00';
                }
            }
        }

        // Функция обновления информации о времени бронирования
        function updateBookingTimeInfo(service) {
            const bookingTimeInfo = document.getElementById('booking-time-info');
            const minBookingTimeText = document.getElementById('min-booking-time-text');
            const currentBookingTime = document.getElementById('current-booking-time');
            const availableTimeMsg = document.getElementById('available-booking-time');
            const unavailableTimeMsg = document.getElementById('unavailable-booking-time');

            if (!service ⠺⠞⠺⠺⠵⠺⠟⠞⠟⠟⠞⠟⠺⠺⠞⠵⠺⠞⠞ !bookingDateInput.value ⠞⠵⠞⠺⠵⠵⠟⠞⠺⠵⠵⠺⠺⠵⠵⠵⠟ !startTimeInput.value) {
                if (bookingTimeInfo) bookingTimeInfo.style.display = 'none';
                return;
            }

            const selectedDatetime = new Date(`${bookingDateInput.value}T${startTimeInput.value}`);
            const now = new Date();

            // Текст о минимальном времени бронирования
            if (service.min_booking_hours > 0) {
                minBookingTimeText.textContent =
                    Эту услугу можно бронировать за ${service.min_booking_hours} часов до времени посещения.;
            } else {
                minBookingTimeText.textContent = 'Эту услугу можно бронировать в любое время.';
            }

            // Форматируем выбранное время
            const selectedDateStr = selectedDatetime.toLocaleDateString('ru-RU', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
            const selectedTimeStr = selectedDatetime.toLocaleTimeString('ru-RU', {
                hour: '2-digit',
                minute: '2-digit'
            });
            currentBookingTime.textContent = Выбранное время: ${selectedDateStr} ${selectedTimeStr};

            // Проверяем доступность времени
            if (service.min_booking_hours > 0) {
                const minBookingDatetime = new Date(now.getTime() + (service.min_booking_hours * 60 * 60 * 1000));

                if (selectedDatetime < minBookingDatetime) {
                    // Время недоступно
                    availableTimeMsg.style.display = 'none';
                    unavailableTimeMsg.style.display = 'block';

                    const minTimeStr = minBookingDatetime.toLocaleString('ru-RU', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    unavailableTimeMsg.innerHTML =
                        ⚠ Это время пока недоступно для бронирования. <br>Можно будет забронировать после ${minTimeStr};
    bookingTimeInfo.className = 'alert alert-warning mb-4';
                } else {
                    // Время доступно
                    availableTimeMsg.style.display = 'block';
                    unavailableTimeMsg.style.display = 'none';
                    availableTimeMsg.textContent = '✓ Это время доступно для бронирования';
                    bookingTimeInfo.className = 'alert alert-info mb-4';
                }
            } else {
                // Можно бронировать в любое время
                availableTimeMsg.style.display = 'block';
                unavailableTimeMsg.style.display = 'none';
                availableTimeMsg.textContent = '✓ Эта услуга доступна для бронирования в любое время';
                bookingTimeInfo.className = 'alert alert-info mb-4';
            }

            bookingTimeInfo.style.display = 'block';
        }

        // Функция расчета итоговой стоимости
        function updateTotalPrice() {
            const serviceId = serviceSelect.value;
            const participants = parseInt(participantsInput.value) || 1;
            const totalPriceSpan = document.getElementById('total-price');

            if (serviceId && serviceData[serviceId]) {
                const service = serviceData[serviceId];
                const totalPrice = service.price * participants;
                totalPriceSpan.textContent = totalPrice.toLocaleString('ru-RU');
            } else {
                totalPriceSpan.textContent = '0';
            }
        }

        function validateBookingTime(service, bookingDate, startTime) {
    if (!service ⠞⠵⠞⠺⠺⠵⠟⠵⠞⠺⠵⠟⠟⠵ !startTime) {
        return { isValid: false, message: 'Заполните дату и время' };
    }

    const selectedDatetime = new Date(`${bookingDate}T${startTime}`);
    const now = new Date();

    // Проверка, что время в будущем
    if (selectedDatetime <= now) {
        return { isValid: false, message: 'Выберите время в будущем' };
    }

    // Проверка минимального времени бронирования
    if (service.min_booking_hours > 0) {
        const minBookingDatetime = new Date(now.getTime() + (service.min_booking_hours * 60 * 60 * 1000));

        if (selectedDatetime < minBookingDatetime) {
            const minTimeStr = minBookingDatetime.toLocaleString('ru-RU', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            return {
                isValid: false,
                message: Эту услугу можно бронировать не ранее чем за ${service.min_booking_hours} часов. Можно выбрать время с: ${minTimeStr}
            };
        }
    }

    return { isValid: true, message: '' };
}

        function updateSubmitButton() {
    const submitBtn = document.getElementById('submit-btn');
    const serviceId = serviceSelect.value;
    const bookingDate = bookingDateInput ? bookingDateInput.value : '';
    const startTime = startTimeInput ? startTimeInput.value : '';

    // Проверяем обязательные поля
    let isValid = true;
    let errorMessage = '';

    // Проверка выбора услуги
    if (!serviceId) {
        isValid = false;
        errorMessage = 'Выберите услугу';
    }

    // Проверка выбора существующего клиента
    const newCustomerChecked = newCustomerCheckbox ? newCustomerCheckbox.checked : false;
    if (!newCustomerChecked) {
        const customerSelected = existingCustomerSelect ? existingCustomerSelect.value : false;
        if (!customerSelected) {
            isValid = false;
            errorMessage = 'Выберите клиента или создайте нового';
        }
    } else {
        // Проверка обязательных полей нового клиента
        const newFirstName = document.getElementById('{{ form.new_first_name.id_for_label }}');
        const newLastName = document.getElementById('{{ form.new_last_name.id_for_label }}');
        const newPhone = document.getElementById('{{ form.new_phone.id_for_label }}');
    if (newFirstName && (!newFirstName.value || newFirstName.value.trim() === '')) {
            isValid = false;
            errorMessage = 'Заполните имя клиента';
        }
        if (newLastName && (!newLastName.value || newLastName.value.trim() === '')) {
            isValid = false;
            errorMessage = 'Заполните фамилию клиента';
        }
        if (newPhone && (!newPhone.value || newPhone.value.trim() === '')) {
            isValid = false;
            errorMessage = 'Заполните телефон клиента';
        }
    }

    // Проверка даты и времени
    if (!bookingDate || !startTime) {
        isValid = false;
        errorMessage = 'Заполните дату и время записи';
    }

    // Проверка минимального времени бронирования
    if (serviceId && serviceData[serviceId]) {
        const service = serviceData[serviceId];
        if (service.min_booking_hours > 0 && bookingDate && startTime) {
            const selectedDatetime = new Date(`${bookingDate}T${startTime}`);
            const now = new Date();
            const minBookingDatetime = new Date(now.getTime() + (service.min_booking_hours * 60 * 60 * 1000));

            if (selectedDatetime < minBookingDatetime) {
                isValid = false;
                errorMessage = 'Выбрано слишком раннее время';
            }
        }
    }

        // Инициализируем валидацию формы
        setupFormValidation();

        // Первоначальная проверка
        setTimeout(updateSubmitButton, 500);

        // Периодическая проверка (на случай асинхронных изменений)
        setInterval(updateSubmitButton, 1000);

        // Проверка времени бронирования
    if (serviceId && serviceData[serviceId] && bookingDate && startTime) {
        const service = serviceData[serviceId];
        const timeValidation = validateBookingTime(service, bookingDate, startTime);

        if (!timeValidation.isValid) {
            isValid = false;
            errorMessage = timeValidation.message;
        }
    }
    // Обновляем состояние кнопки
    if (submitBtn) {
        submitBtn.disabled = !isValid;

        // Меняем стиль кнопки в зависимости от состояния
        if (isValid) {
            submitBtn.className = 'btn btn-primary';
            submitBtn.title = 'Создать запись';
        } else {
            submitBtn.className = 'btn btn-secondary';
            submitBtn.title = errorMessage || 'Заполните все обязательные поля';

            // Добавляем tooltip для ошибки
            if (!submitBtn.hasAttribute('data-bs-toggle')) {
                submitBtn.setAttribute('data-bs-toggle', 'tooltip');
                submitBtn.setAttribute('data-bs-placement', 'top');
                submitBtn.setAttribute('data-bs-title', errorMessage || 'Заполните все обязательные поля');

                // Инициализируем tooltip
                if (typeof bootstrap !== 'undefined') {
                    new bootstrap.Tooltip(submitBtn);
                }
            }
        }
    }

    return isValid;
}

// Добавьте проверки на изменение всех полей формы
function setupFormValidation() {
    // Отслеживаем изменения во всех полях формы
    const form = document.getElementById('booking-form');
    if (form) {
        const inputs = form.querySelectorAll('input, select, textarea');
        inputs.forEach(input => {
            input.addEventListener('change', updateSubmitButton);
            input.addEventListener('input', updateSubmitButton);
            input.addEventListener('blur', updateSubmitButton);
        });
    }

    // Отслеживаем изменения в переключателе нового клиента
    if (newCustomerCheckbox) {
        newCustomerCheckbox.addEventListener('change', function() {
            setTimeout(updateSubmitButton, 100); // Даем время на переключение
        });
    }
}

        // Функция расчета времени окончания
        function updateEndTime() {
            const serviceId = serviceSelect.value;
            const endTimeDiv = document.getElementById('end-time');
            const endTimeValue = document.getElementById('end-time-value');
    if (serviceId && serviceData[serviceId] && startTimeInput && startTimeInput.value) {
                const service = serviceData[serviceId];
                const startTime = startTimeInput.value;

                // Расчет времени окончания
                const [hours, minutes] = startTime.split(':').map(Number);
                let endHours = hours + Math.floor(service.duration / 60);
                let endMinutes = minutes + (service.duration % 60);

                if (endMinutes >= 60) {
                    endHours += 1;
                    endMinutes -= 60;
                }

                if (endHours >= 24) {
                    endHours -= 24;
                }

                const endTimeStr = endHours.toString().padStart(2, '0') + ':' +
                                   endMinutes.toString().padStart(2, '0');
                endTimeValue.textContent = endTimeStr;
                endTimeDiv.style.display = 'block';
            } else {
                if (endTimeDiv) endTimeDiv.style.display = 'none';
            }
        }

        // События
        if (serviceSelect) {
            serviceSelect.addEventListener('change', updateServiceInfo);
        }

        if (participantsInput) {
            participantsInput.addEventListener('input', updateTotalPrice);
        }

        if (startTimeInput) {
            startTimeInput.addEventListener('change', function() {
                updateEndTime();
                if (serviceSelect.value) {
                    updateBookingTimeInfo(serviceData[serviceSelect.value]);
                }
            });
        }

        if (bookingDateInput) {
            bookingDateInput.addEventListener('change', function() {
                if (serviceSelect.value) {
                    updateBookingTimeInfo(serviceData[serviceSelect.value]);
                }
            });
        }

        // Инициализация
        if (serviceSelect.value) {
            updateServiceInfo();
        }
        updateTotalPrice();

        // Установка минимальной даты (сегодня)
        const today = new Date().toISOString().split('T')[0];
        if (bookingDateInput) {
            bookingDateInput.min = today;
            if (!bookingDateInput.value) {
                bookingDateInput.value = today;
            }
        }

        // Установка времени по умолчанию (ближайший час)
        if (startTimeInput && !startTimeInput.value) {
            const now = new Date();
            const nextHour = new Date(now.getTime() + 60 * 60 * 1000);
            startTimeInput.value = nextHour.getHours().toString().padStart(2, '0') + ':00';
        }

        // Установка участников по умолчанию
        if (participantsInput && !participantsInput.value) {
            participantsInput.value = 1;
        }
    });
</script>
{% endblock %}
