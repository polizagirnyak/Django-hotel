{% extends 'service/base.html' %}
{% load static %}
 
{% block title %}{{ title }}{% endblock %}
 
{% block content %}
<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-md-12 col-lg-10">
            <div class="card shadow">
                <div class="card-header bg-white py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-edit me-2"></i>{{ title }}
                        </h5>
                        <div>
                            <a href="{% url 'service_booking_detail' booking.id %}" class="btn btn-sm btn-outline-info me-2">
                                <i class="fas fa-info-circle"></i> Просмотр
                            </a>
                            <a href="{% url 'service_booking_list' %}" class="btn btn-sm btn-outline-secondary">
                                <i class="fas fa-arrow-left"></i> К списку
                            </a>
                        </div>
                    </div>
                </div>
 
                <div class="card-body">
                    <!-- Информация о клиенте (только для чтения) -->
                    <div class="alert alert-info mb-4">
                        <div class="d-flex align-items-center">
                            <div class="flex-shrink-0">
                                <i class="fas fa-user-circle fa-2x"></i>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <h6 class="alert-heading mb-1">Информация о клиенте</h6>
                                <p class="mb-0">
                                    <strong>{{ booking.customer.get_full_name }}</strong><br>
                                    <small>
                                        <i class="fas fa-phone me-1"></i>{{ booking.customer.phone|default:'—' }}
                                        {% if booking.customer.email %}
                                        | <i class="fas fa-envelope me-1"></i>{{ booking.customer.email }}
                                        {% endif %}
                                    </small>
                                </p>
                            </div>
                            <div class="flex-shrink-0">
                                <span class="badge bg-secondary">Клиент не редактируется</span>
                            </div>
                        </div>
                    </div>
 
                    <form method="post" novalidate id="booking-edit-form">
                        {% csrf_token %}
 
                        {% if form.non_field_errors %}
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-circle me-2"></i>
                            {% for error in form.non_field_errors %}
                            {{ error }}
                            {% endfor %}
                        </div>
                        {% endif %}
 
                        <div class="row">
                            <!-- Левая колонка - Информация об услуге -->
                            <div class="col-md-6">
                                <div class="card mb-4">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0">
                                            <i class="fas fa-spa me-2"></i>Услуга и время
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <!-- Услуга -->
                                        <div class="mb-3">
                                            <label for="{{ form.service.id_for_label }}" class="form-label fw-semibold">
                                                Услуга *
                                            </label>
                                            {{ form.service }}
                                            {% if form.service.errors %}
                                            <div class="invalid-feedback d-block">
                                                {{ form.service.errors }}
                                            </div>
                                            {% endif %}
                                        </div>
 
                                        <!-- Информация об услуге (динамически) -->
                                        <div id="service-info" class="card border-primary mt-3" style="display: none;">
                                            <div class="card-body p-3">
                                                <div class="d-flex justify-content-between align-items-start">
                                                    <div>
                                                        <h6 class="card-title mb-1" id="service-name"></h6>
                                                        <p class="card-text text-muted small mb-2" id="service-description"></p>
                                                        <div class="d-flex align-items-center gap-2 flex-wrap">
                                                            <span class="badge bg-info" id="service-duration"></span>
                                                            <span class="badge bg-secondary" id="service-capacity"></span>
                                                            <span class="badge bg-warning" id="service-booking-time" style="display: none;"></span>
                                                        </div>
                                                    </div>
                                                    <div class="text-end">
                                                        <div class="text-success fw-bold fs-5" id="service-price"></div>
                                                        <small class="text-muted">за 1 чел.</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
 
                                        <div class="row mt-3">
                                            <div class="col-md-6 mb-3">
                                                <label for="{{ form.booking_date.id_for_label }}" class="form-label fw-semibold">
                                                    Дата записи *
                                                </label>
                                                {{ form.booking_date }}
                                                {% if form.booking_date.errors %}
                                                <div class="invalid-feedback d-block">
                                                    {{ form.booking_date.errors }}
                                                </div>
                                                {% endif %}
                                                {% if form.booking_date.help_text %}
                                                <small class="form-text text-muted">
                                                    {{ form.booking_date.help_text }}
                                                </small>
                                                {% endif %}
                                            </div>
 
                                            <div class="col-md-6 mb-3">
                                                <label for="{{ form.start_time.id_for_label }}" class="form-label fw-semibold">
                                                    Время начала *
                                                </label>
                                                {{ form.start_time }}
                                                {% if form.start_time.errors %}
                                                <div class="invalid-feedback d-block">
                                                    {{ form.start_time.errors }}
                                                </div>
                                                {% endif %}
                                                <div id="end-time" class="mt-2 small text-muted" style="display: none;">
                                                    <i class="fas fa-hourglass-end me-1"></i>
                                                    Окончание: <span id="end-time-value" class="fw-semibold"></span>
                                                </div>
                                                {% if form.start_time.help_text %}
                                                <small class="form-text text-muted">
                                                    {{ form.start_time.help_text }}
                                                </small>
                                                {% endif %}
                                            </div>
                                        </div>
 
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="{{ form.participants.id_for_label }}" class="form-label fw-semibold">
                                                    Количество участников
                                                </label>
                                                <div class="input-group">
                                                    {{ form.participants }}
                                                    <span class="input-group-text">чел.</span>
                                                </div>
                                                {% if form.participants.errors %}
                                                <div class="invalid-feedback d-block">
                                                    {{ form.participants.errors }}
                                                </div>
                                                {% endif %}
                                                <small class="form-text text-muted" id="max-capacity-info">
                                                    Максимально: <span id="max-capacity" class="fw-semibold">1</span> человек
                                                </small>
                                            </div>
 
                                            <div class="col-md-6 mb-3">
                                                <label for="{{ form.status.id_for_label }}" class="form-label fw-semibold">
                                                    Статус записи *
                                                </label>
                                                {{ form.status }}
                                                {% if form.status.errors %}
                                                <div class="invalid-feedback d-block">
                                                    {{ form.status.errors }}
                                                </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
 
                            <!-- Правая колонка - Дополнительная информация -->
                            <div class="col-md-6">
                                <div class="card mb-4">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0">
                                            <i class="fas fa-info-circle me-2"></i>Дополнительная информация
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-4">
                                            <label for="{{ form.special_requests.id_for_label }}" class="form-label fw-semibold">
                                                Особые пожелания
                                            </label>
                                            {{ form.special_requests }}
                                            {% if form.special_requests.errors %}
                                            <div class="invalid-feedback d-block">
                                                {{ form.special_requests.errors }}
                                            </div>
                                            {% endif %}
                                            <small class="form-text text-muted">
                                                Предпочтения и пожелания клиента к услуге
                                            </small>
                                        </div>
 
                                        <div class="mb-4">
                                            <label for="{{ form.notes.id_for_label }}" class="form-label fw-semibold">
                                                Примечания администратора
                                            </label>
                                            {{ form.notes }}
                                            {% if form.notes.errors %}
                                            <div class="invalid-feedback d-block">
                                                {{ form.notes.errors }}
                                            </div>
                                            {% endif %}
                                            <small class="form-text text-muted">
                                                Внутренние заметки для администрации
                                            </small>
                                        </div>
                                    </div>
                                </div>
 
                                <!-- Информация о записи -->
                                <div class="card mb-4">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0">
                                            <i class="fas fa-clock me-2"></i>Информация о записи
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-sm-6">
                                                <small class="text-muted d-block">Создана</small>
                                                <strong>{{ booking.created_at|date:"d.m.Y H:i" }}</strong>
                                                <small class="text-muted d-block mt-2">Кем создана</small>
                                                <strong>{{ booking.created_by.get_full_name|default:booking.created_by.username }}</strong>
                                            </div>
                                            <div class="col-sm-6">
                                                <small class="text-muted d-block">Последнее изменение</small>
                                                <strong>{{ booking.updated_at|date:"d.m.Y H:i"|default:'—' }}</strong>
                                                {% if booking.updated_by %}
                                                <small class="text-muted d-block mt-2">Кем изменено</small>
                                                <strong>{{ booking.updated_by.get_full_name|default:booking.updated_by.username }}</strong>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
 
                        <!-- Итоговая стоимость -->
                        <div class="alert alert-success mb-4">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="alert-heading mb-1">
                                        <i class="fas fa-calculator me-2"></i>Итоговая стоимость
                                    </h6>
                                    <p class="mb-0">
                                        <small class="text-muted">
                                            Рассчитывается автоматически на основе услуги и количества участников
                                        </small>
                                    </p>
                                </div>
                                <div class="text-end">
                                    <div class="fs-4 fw-bold text-success" id="total-price">0</div>
                                    <small class="text-muted">рублей</small>
                                </div>
                            </div>
                        </div>
 
                        <!-- Кнопки действий -->
                        <div class="d-flex justify-content-between mt-4 pt-3 border-top">
                            <div>
                                <a href="{% url 'service_booking_delete' booking.id %}" class="btn btn-danger">
                                    <i class="fas fa-trash me-2"></i>Удалить запись
                                </a>
                            </div>
                            <div>
                                <a href="{% url 'service_booking_list' %}" class="btn btn-secondary me-2">
                                    <i class="fas fa-times me-2"></i>Отмена
                                </a>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-2"></i>Сохранить изменения
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
 
<style>
    .form-control, .form-select, textarea.form-control {
        border-radius: 8px;
        border: 1px solid #dee2e6;
        padding: 0.75rem;
        transition: all 0.3s ease;
    }
 
    .form-control:focus, .form-select:focus, textarea.form-control:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        transform: translateY(-1px);
    }
 
    .form-label {
        color: #2c3e50;
        margin-bottom: 0.5rem;
        font-weight: 500;
    }
 
    .fw-semibold {
        font-weight: 600;
    }
 
    .card-header.bg-light {
        background-color: #f8f9fa !important;
    }
 
    .badge {
        font-weight: 500;
        padding: 0.35em 0.65em;
    }
 
    .alert {
        border-radius: 10px;
        border-left: 4px solid;
    }
 
    .alert-success {
        border-left-color: #2e7d32;
    }
 
    .alert-info {
        border-left-color: #1976d2;
    }
 
    .card.border-primary {
        border-color: #667eea !important;
        border-width: 2px;
    }
 
    .input-group-text {
        background-color: #f8f9fa;
        border-color: #dee2e6;
    }
</style>
 
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Данные об услугах
        const serviceData = {{ services_json|safe }};
 
        // Начальные значения из контекста
        const initialServiceId = '{{ initial_service_id|safe }}';
        const initialParticipants = {{ initial_participants|default:1 }};
        const initialDate = '{{ initial_date|safe }}';
        const initialTime = '{{ initial_time|safe }}';
 
        // Элементы DOM
        const serviceSelect = document.getElementById('{{ form.service.id_for_label }}');
        const participantsInput = document.getElementById('{{ form.participants.id_for_label }}');
        const bookingDateInput = document.getElementById('{{ form.booking_date.id_for_label }}');
        const startTimeInput = document.getElementById('{{ form.start_time.id_for_label }}');
 
        // Функция обновления информации об услуге
        function updateServiceInfo() {
            const serviceId = serviceSelect.value;
            const serviceInfo = document.getElementById('service-info');
 
            if (serviceId && serviceData[serviceId]) {
                const service = serviceData[serviceId];
 
                document.getElementById('service-name').textContent = service.name;
                document.getElementById('service-description').textContent = service.description || 'Нет описания';
                document.getElementById('service-price').textContent = service.price + ' руб.';
 
                // Форматирование длительности
                const hours = Math.floor(service.duration / 60);
                const minutes = service.duration % 60;
                let durationText = '';
                if (hours > 0) durationText += hours + ' ч ';
                if (minutes > 0) durationText += minutes + ' мин';
                document.getElementById('service-duration').textContent = durationText.trim();
 
                document.getElementById('service-capacity').textContent = 'до ' + service.max_capacity + ' чел.';
                document.getElementById('max-capacity').textContent = service.max_capacity;
 
                // Информация о времени бронирования
                const bookingTimeBadge = document.getElementById('service-booking-time');
                if (service.min_booking_hours > 0) {
                    bookingTimeBadge.textContent = 'Бронировать за ' + service.min_booking_hours + ' ч.';
                    bookingTimeBadge.style.display = 'inline-block';
                } else {
                    bookingTimeBadge.style.display = 'none';
                }
 
                // Устанавливаем максимальное значение для участников
                if (participantsInput) {
                    participantsInput.max = service.max_capacity;
                    if (participantsInput.value > service.max_capacity) {
                        participantsInput.value = service.max_capacity;
                    }
                }
 
                serviceInfo.style.display = 'block';
                updateTotalPrice();
                updateTimeConstraints(service);
                updateEndTime(); // Обновляем время окончания при изменении услуги
            } else {
                if (serviceInfo) serviceInfo.style.display = 'none';
            }
        }
 
        // Функция обновления ограничений по времени
        function updateTimeConstraints(service) {
    if (!service || !bookingDateInput) return;
 
    const now = new Date();
 
    if (service.min_booking_hours > 0) {
        // Рассчитываем минимальное доступное время
        const minDatetime = new Date(now.getTime() + (service.min_booking_hours * 60 * 60 * 1000));
        const minDate = minDatetime.toISOString().split('T')[0];
 
        // Устанавливаем минимальную дату
        bookingDateInput.min = minDate;
 
        // ИСПРАВЛЕНИЕ: НЕ перезаписываем дату если это начальная загрузка
        // Проверяем, совпадает ли текущее значение с начальным
        const isInitialValue = bookingDateInput.value === initialDate;
 
        // Если выбранная дата меньше минимальной И это НЕ начальное значение
        if (bookingDateInput.value && bookingDateInput.value < minDate && !isInitialValue) {
            bookingDateInput.value = minDate;
            alert('Дата обновлена, так как выбранная дата меньше минимально допустимой для этой услуги');
        }
 
        // Если выбранная дата сегодня, устанавливаем минимальное время
        if (bookingDateInput.value === minDate && startTimeInput) {
            // Рассчитываем минимальное время
            let minHour = minDatetime.getHours();
            let minMinute = minDatetime.getMinutes();
 
            // Округляем до ближайших 15 минут в большую сторону
            minMinute = Math.ceil(minMinute / 15) * 15;
            if (minMinute >= 60) {
                minHour += 1;
                minMinute = 0;
            }
 
            const minTime = `${minHour.toString().padStart(2, '0')}:${minMinute.toString().padStart(2, '0')}`;
            startTimeInput.min = minTime;
 
            // ИСПРАВЛЕНИЕ: также проверяем начальное значение времени
            const isInitialTime = startTimeInput.value === initialTime;
 
            // Если текущее время меньше минимального И это НЕ начальное значение
            if (startTimeInput.value && startTimeInput.value < minTime && !isInitialTime) {
                startTimeInput.value = minTime;
            }
        } else if (startTimeInput) {
            // Для будущих дат снимаем ограничение времени
            startTimeInput.min = '00:00';
        }
    } else {
        // Если нет ограничений, минимальная дата - сегодня
        const today = new Date().toISOString().split('T')[0];
        bookingDateInput.min = today;
        if (startTimeInput) {
            startTimeInput.min = '00:00';
        }
    }
}
 
        // Функция расчета итоговой стоимости
        function updateTotalPrice() {
            const serviceId = serviceSelect.value;
            const participants = parseInt(participantsInput.value) || 1;
            const totalPriceSpan = document.getElementById('total-price');
 
            if (serviceId && serviceData[serviceId]) {
                const service = serviceData[serviceId];
                const totalPrice = service.price * participants;
                totalPriceSpan.textContent = totalPrice.toLocaleString('ru-RU');
            } else {
                totalPriceSpan.textContent = '0';
            }
        }
 
        // Функция расчета времени окончания - ИСПРАВЛЕННАЯ
        function updateEndTime() {
            const serviceId = serviceSelect.value;
            const endTimeDiv = document.getElementById('end-time');
            const endTimeValue = document.getElementById('end-time-value');
 
            if (serviceId && serviceData[serviceId] && startTimeInput && startTimeInput.value) {
                const service = serviceData[serviceId];
                const startTimeStr = startTimeInput.value;
 
                // Разбираем время начала
                const [hours, minutes] = startTimeStr.split(':').map(Number);
 
                // Создаем объект Date для корректного расчета времени
                const startDate = new Date();
                startDate.setHours(hours, minutes, 0);
 
                // Добавляем длительность услуги в минутах
                const endDate = new Date(startDate.getTime() + service.duration * 60000);
 
                // Форматируем время окончания
                const endHours = endDate.getHours().toString().padStart(2, '0');
                const endMinutes = endDate.getMinutes().toString().padStart(2, '0');
                const endTimeStr = endHours + ':' + endMinutes;
 
                // Проверяем, не перешли ли на следующий день
                if (endDate.getDate() !== startDate.getDate()) {
                    endTimeValue.innerHTML = endTimeStr + ' <span class="text-warning">(следующий день)</span>';
                } else {
                    endTimeValue.textContent = endTimeStr;
                }
 
                endTimeDiv.style.display = 'block';
            } else {
                if (endTimeDiv) endTimeDiv.style.display = 'none';
            }
        }
 
        // Функция проверки и восстановления начальных значений
        function restoreInitialValues() {
            // Восстанавливаем выбранную услугу
            if (initialServiceId && serviceSelect) {
                serviceSelect.value = initialServiceId;
            }
 
            // Восстанавливаем количество участников
            if (initialParticipants && participantsInput) {
                participantsInput.value = initialParticipants;
            }
 
            // Восстанавливаем дату
            if (initialDate && bookingDateInput) {
                bookingDateInput.value = initialDate;
            }
 
            // Восстанавливаем время
            if (initialTime && startTimeInput) {
                startTimeInput.value = initialTime;
            }
        }
 
        // События
        if (serviceSelect) {
            serviceSelect.addEventListener('change', function() {
                updateServiceInfo();
                updateEndTime(); // Обновляем время окончания при изменении услуги
            });
        }
 
        if (participantsInput) {
            participantsInput.addEventListener('input', updateTotalPrice);
        }
 
        if (startTimeInput) {
            startTimeInput.addEventListener('change', function() {
                updateEndTime(); // Обновляем время окончания при изменении времени начала
            });
            startTimeInput.addEventListener('input', function() {
                updateEndTime(); // Также обновляем при вводе
            });
        }
 
        if (bookingDateInput) {
            bookingDateInput.addEventListener('change', function() {
                if (serviceSelect.value) {
                    updateTimeConstraints(serviceData[serviceSelect.value]);
                }
            });
        }
 
        // Инициализация
        restoreInitialValues(); // Сначала восстанавливаем значения
        setTimeout(function() {
            if (serviceSelect.value) {
                updateServiceInfo(); // Затем обновляем информацию об услуге
                updateEndTime(); // И время окончания
            }
            updateTotalPrice(); // И стоимость
        }, 100); // Небольшая задержка для гарантии загрузки DOM
    });
</script>
{% endblock %}