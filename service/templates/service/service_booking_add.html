{% extends 'service/base.html' %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-md-12 col-lg-10">
            <div class="card shadow">
                <div class="card-header bg-white py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">{{ title }}</h5>
                        <a href="{% url 'service_booking_list' %}" class="btn btn-sm btn-outline-secondary">
                            <i class="fas fa-arrow-left"></i> Назад
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    <form method="post" novalidate id="booking-form">
                        {% csrf_token %}

                        {% if form.non_field_errors %}
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-circle me-2"></i>
                            {% for error in form.non_field_errors %}
                            {{ error }}
                            {% endfor %}
                        </div>
                        {% endif %}

                        <div class="row">
                            <!-- Левая колонка - Выбор/Создание клиента -->
                            <div class="col-md-6">
                                <div class="card mb-4">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0">
                                            <i class="fas fa-user me-2"></i>Информация о клиенте
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <!-- Переключатель между выбором и созданием -->
                                        <div class="mb-3">
                                            <div class="form-check form-switch">
                                                {{ form.new_customer }}
                                                <label class="form-check-label" for="{{ form.new_customer.id_for_label }}">
                                                    <strong>Создать нового клиента</strong>
                                                </label>
                                            </div>
                                            <small class="form-text text-muted">
                                                Отметьте, чтобы создать нового клиента, или выберите из списка
                                            </small>
                                        </div>

                                        <!-- Выбор существующего клиента -->
                                        <div id="existing-customer-section">
                                            <div class="mb-3">
                                                <label for="{{ form.customer.id_for_label }}" class="form-label fw-semibold">
                                                    Выберите клиента *
                                                </label>
                                                {{ form.customer }}
                                                {% if form.customer.errors %}
                                                <div class="invalid-feedback d-block">
                                                    {{ form.customer.errors }}
                                                </div>
                                                {% endif %}
                                                <small class="form-text text-muted">
                                                    <a href="{% url 'customer_list' %}" target="_blank">
                                                        <i class="fas fa-external-link-alt"></i> Все клиенты
                                                    </a>
                                                </small>
                                            </div>
                                        </div>

                                        <!-- Форма нового клиента (скрыта по умолчанию) -->
                                        <div id="new-customer-section" style="display: none;">
                                            <div class="alert alert-info mb-3">
                                                <i class="fas fa-info-circle me-2"></i>
                                                Заполните данные нового клиента. Обязательные поля: Имя, Фамилия, Телефон.
                                            </div>

                                            <div class="row">
                                                <div class="col-md-6 mb-3">
                                                    <label for="{{ form.new_first_name.id_for_label }}" class="form-label">
                                                        Имя *
                                                    </label>
                                                    {{ form.new_first_name }}
                                                    {% if form.new_first_name.errors %}
                                                    <div class="invalid-feedback d-block">
                                                        {{ form.new_first_name.errors }}
                                                    </div>
                                                    {% endif %}
                                                </div>

                                                <div class="col-md-6 mb-3">
                                                    <label for="{{ form.new_last_name.id_for_label }}" class="form-label">
                                                        Фамилия *
                                                    </label>
                                                    {{ form.new_last_name }}
                                                    {% if form.new_last_name.errors %}
                                                    <div class="invalid-feedback d-block">
                                                        {{ form.new_last_name.errors }}
                                                    </div>
                                                    {% endif %}
                                                </div>
                                            </div>

                                            <div class="row">
                                                <div class="col-md-6 mb-3">
                                                    <label for="{{ form.new_phone.id_for_label }}" class="form-label">
                                                        Телефон *
                                                    </label>
                                                    {{ form.new_phone }}
                                                    {% if form.new_phone.errors %}
                                                    <div class="invalid-feedback d-block">
                                                        {{ form.new_phone.errors }}
                                                    </div>
                                                    {% endif %}
                                                    <small class="form-text text-muted">
                                                        Формат: +7 (999) 123-45-67
                                                    </small>
                                                </div>

                                                <div class="col-md-6 mb-3">
                                                    <label for="{{ form.new_email.id_for_label }}" class="form-label">
                                                        Email
                                                    </label>
                                                    {{ form.new_email }}
                                                    {% if form.new_email.errors %}
                                                    <div class="invalid-feedback d-block">
                                                        {{ form.new_email.errors }}
                                                    </div>
                                                    {% endif %}
                                                </div>
                                            </div>

                                            <div class="row">
                                                <div class="col-md-6 mb-3">
                                                    <label for="{{ form.new_passport_number.id_for_label }}" class="form-label">
                                                        Номер паспорта
                                                    </label>
                                                    {{ form.new_passport_number }}
                                                    {% if form.new_passport_number.errors %}
                                                    <div class="invalid-feedback d-block">
                                                        {{ form.new_passport_number.errors }}
                                                    </div>
                                                    {% endif %}
                                                </div>

                                                <div class="col-md-6 mb-3">
                                                    <label for="{{ form.new_birthday.id_for_label }}" class="form-label">
                                                        Дата рождения
                                                    </label>
                                                    {{ form.new_birthday }}
                                                    {% if form.new_birthday.errors %}
                                                    <div class="invalid-feedback d-block">
                                                        {{ form.new_birthday.errors }}
                                                    </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Правая колонка - Выбор услуги и времени -->
                            <div class="col-md-6">
                                <div class="card mb-4">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0">
                                            <i class="fas fa-spa me-2"></i>Выбор услуги и времени
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label for="{{ form.service.id_for_label }}" class="form-label fw-semibold">
                                                Услуга *
                                            </label>
                                            {{ form.service }}
                                            {% if form.service.errors %}
                                            <div class="invalid-feedback d-block">
                                                {{ form.service.errors }}
                                            </div>
                                            {% endif %}
                                            <small class="form-text text-muted">
                                                <a href="{% url 'service_list' %}" target="_blank">
                                                    <i class="fas fa-external-link-alt"></i> Все услуги
                                                </a>
                                            </small>
                                        </div>

                                        <!-- Информация об услуге -->
                                        <div id="service-info" class="card border-primary mt-3" style="display: none;">
                                            <div class="card-body p-3">
                                                <div class="d-flex justify-content-between align-items-start">
                                                    <div>
                                                        <h6 class="card-title mb-1" id="service-name"></h6>
                                                        <p class="card-text text-muted small mb-2" id="service-description"></p>
                                                        <div class="d-flex align-items-center gap-2 flex-wrap">
                                                            <span class="badge bg-info" id="service-duration"></span>
                                                            <span class="badge bg-secondary" id="service-capacity"></span>
                                                            <span class="badge bg-warning" id="service-booking-time" style="display: none;"></span>
                                                        </div>
                                                    </div>
                                                    <div class="text-end">
                                                        <div class="text-success fw-bold fs-5" id="service-price"></div>
                                                        <small class="text-muted">за 1 чел.</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="row mt-3">
                                            <div class="col-md-6 mb-3">
                                                <label for="{{ form.booking_date.id_for_label }}" class="form-label fw-semibold">
                                                    Дата записи *
                                                </label>
                                                {{ form.booking_date }}
                                                {% if form.booking_date.errors %}
                                                <div class="invalid-feedback d-block">
                                                    {{ form.booking_date.errors }}
                                                </div>
                                                {% endif %}
                                            </div>

                                            <div class="col-md-6 mb-3">
                                                <label for="{{ form.start_time.id_for_label }}" class="form-label fw-semibold">
                                                    Время начала *
                                                </label>
                                                {{ form.start_time }}
                                                {% if form.start_time.errors %}
                                                <div class="invalid-feedback d-block">
                                                    {{ form.start_time.errors }}
                                                </div>
                                                {% endif %}
                                                <div id="end-time" class="mt-2 small text-muted" style="display: none;">
                                                    <i class="fas fa-hourglass-end me-1"></i>
                                                    Окончание: <span id="end-time-value" class="fw-semibold"></span>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="{{ form.participants.id_for_label }}" class="form-label fw-semibold">
                                                    Количество участников
                                                </label>
                                                <div class="input-group">
                                                    {{ form.participants }}
                                                    <span class="input-group-text">чел.</span>
                                                </div>
                                                {% if form.participants.errors %}
                                                <div class="invalid-feedback d-block">
                                                    {{ form.participants.errors }}
                                                </div>
                                                {% endif %}
                                                <small class="form-text text-muted" id="max-capacity-info">
                                                    Максимально: <span id="max-capacity" class="fw-semibold">1</span> человек
                                                </small>
                                            </div>

                                            <div class="col-md-6 mb-3">
                                                <label for="{{ form.status.id_for_label }}" class="form-label fw-semibold">
                                                    Статус записи *
                                                </label>
                                                {{ form.status }}
                                                {% if form.status.errors %}
                                                <div class="invalid-feedback d-block">
                                                    {{ form.status.errors }}
                                                </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Информация о времени бронирования -->
                        <div id="booking-time-info" class="alert alert-warning mb-4" style="display: none;">
                            <div class="d-flex">
                                <div class="me-3">
                                    <i class="fas fa-clock"></i>
                                </div>
                                <div>
                                    <h6 class="alert-heading mb-1">Информация о бронировании</h6>
                                    <p class="mb-0" id="min-booking-time-text"></p>
                                    <p class="mb-0 mt-1 small" id="current-booking-time"></p>
                                    <p class="mb-0 mt-1 small text-success" id="available-booking-time" style="display: none;">
                                        ✓ Это время доступно для бронирования
                                    </p>
                                    <p class="mb-0 mt-1 small text-danger" id="unavailable-booking-time" style="display: none;">
                                        ⚠ Это время пока недоступно для бронирования
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- Дополнительные поля -->
                        <div class="row">
                            <div class="col-md-6 mb-4">
                                <div class="card">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0">
                                            <i class="fas fa-comment-medical me-2"></i>Особые пожелания
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        {{ form.special_requests }}
                                        {% if form.special_requests.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.special_requests.errors }}
                                        </div>
                                        {% endif %}
                                        <small class="form-text text-muted">
                                            Предпочтения и пожелания клиента к услуге
                                        </small>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-6 mb-4">
                                <div class="card">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0">
                                            <i class="fas fa-sticky-note me-2"></i>Примечания администратора
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        {{ form.notes }}
                                        {% if form.notes.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.notes.errors }}
                                        </div>
                                        {% endif %}
                                        <small class="form-text text-muted">
                                            Внутренние заметки для администрации отеля
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Итоговая стоимость -->
                        <div class="alert alert-success mb-4">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="alert-heading mb-1">
                                        <i class="fas fa-calculator me-2"></i>Итоговая стоимость
                                    </h6>
                                    <p class="mb-0">
                                        <small class="text-muted">
                                            Рассчитывается автоматически на основе услуги и количества участников
                                        </small>
                                    </p>
                                </div>
                                <div class="text-end">
                                    <div class="fs-4 fw-bold text-success" id="total-price">0</div>
                                    <small class="text-muted">рублей</small>
                                </div>
                            </div>
                        </div>

                        <!-- Кнопки действий -->
                        <div class="d-flex justify-content-between mt-4 pt-3 border-top">
                            <a href="{% url 'service_booking_list' %}" class="btn btn-secondary">
                                <i class="fas fa-times me-2"></i>Отмена
                            </a>
                            <div>
                                <button type="submit" name="save_and_new" value="true" class="btn btn-outline-primary me-2">
                                    <i class="fas fa-save me-2"></i>Сохранить и добавить еще
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-check me-2"></i>Создать запись
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .form-control, .form-select, textarea.form-control {
        border-radius: 8px;
        border: 1px solid #dee2e6;
        padding: 0.75rem;
        transition: all 0.3s ease;
    }

    .form-control:focus, .form-select:focus, textarea.form-control:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        transform: translateY(-1px);
    }

    .form-check-input:checked {
        background-color: #667eea;
        border-color: #667eea;
    }

    .form-check-input:focus {
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    }

    .form-label {
        color: #2c3e50;
        margin-bottom: 0.5rem;
        font-weight: 500;
    }

    .fw-semibold {
        font-weight: 600;
    }

    .card-header.bg-light {
        background-color: #f8f9fa !important;
    }

    .badge {
        font-weight: 500;
        padding: 0.35em 0.65em;
    }

    .input-group-text {
        background-color: #f8f9fa;
        border-color: #dee2e6;
    }

    .alert {
        border-radius: 10px;
        border-left: 4px solid;
    }

    .alert-success {
        border-left-color: #2e7d32;
    }

    .alert-warning {
        border-left-color: #ef6c00;
    }

    .alert-info {
        border-left-color: #1976d2;
    }

    .card.border-primary {
        border-color: #667eea !important;
        border-width: 2px;
    }

    .form-switch .form-check-input {
        width: 3em;
        height: 1.5em;
        margin-right: 0.5rem;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Данные об услугах
        const serviceData = {{ services_json|safe }};

        // Элементы DOM
        const newCustomerCheckbox = document.getElementById('{{ form.new_customer.id_for_label }}');
        const existingCustomerSection = document.getElementById('existing-customer-section');
        const newCustomerSection = document.getElementById('new-customer-section');
        const existingCustomerSelect = document.getElementById('{{ form.customer.id_for_label }}');
        const serviceSelect = document.getElementById('{{ form.service.id_for_label }}');
        const participantsInput = document.getElementById('{{ form.participants.id_for_label }}');
        const bookingDateInput = document.getElementById('{{ form.booking_date.id_for_label }}');
        const startTimeInput = document.getElementById('{{ form.start_time.id_for_label }}');

        // Переключатель нового клиента
        if (newCustomerCheckbox) {
    newCustomerCheckbox.addEventListener('change', function() {
        if (this.checked) {
            existingCustomerSection.style.display = 'none';
            newCustomerSection.style.display = 'block';

            // Убираем required с поля выбора клиента
            if (existingCustomerSelect) {
                existingCustomerSelect.required = false;
                existingCustomerSelect.value = ''; // Сбрасываем выбор
            }

            // Делаем обязательные поля нового клиента required
            const requiredFields = [
                '{{ form.new_first_name.id_for_label }}',
                '{{ form.new_last_name.id_for_label }}',
                '{{ form.new_phone.id_for_label }}'
            ];

            requiredFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) field.required = true;
            });
        } else {
            existingCustomerSection.style.display = 'block';
            newCustomerSection.style.display = 'none';

            // Делаем поле выбора клиента required
            if (existingCustomerSelect) {
                existingCustomerSelect.required = true;
            }

            // Убираем required с полей нового клиента
            const newCustomerFields = newCustomerSection.querySelectorAll('input');
            newCustomerFields.forEach(field => {
                field.required = false;
            });
        }
    });

            // Инициализируем состояние
           if (newCustomerCheckbox.checked) {
        existingCustomerSection.style.display = 'none';
        newCustomerSection.style.display = 'block';
        if (existingCustomerSelect) {
            existingCustomerSelect.required = false;
        }
    } else {
        existingCustomerSection.style.display = 'block';
        newCustomerSection.style.display = 'none';
        if (existingCustomerSelect) {
            existingCustomerSelect.required = true;
        }
    }
}

        // Функция обновления информации об услуге
        function updateServiceInfo() {
            const serviceId = serviceSelect.value;
            const serviceInfo = document.getElementById('service-info');

            if (serviceId && serviceData[serviceId]) {
                const service = serviceData[serviceId];

                document.getElementById('service-name').textContent = service.name;
                document.getElementById('service-description').textContent = service.description;
                document.getElementById('service-price').textContent = service.price + ' руб.';

                // Форматирование длительности
                const hours = Math.floor(service.duration / 60);
                const minutes = service.duration % 60;
                let durationText = '';
                if (hours > 0) durationText += hours + ' ч ';
                if (minutes > 0) durationText += minutes + ' мин';
                document.getElementById('service-duration').textContent = durationText.trim();

                document.getElementById('service-capacity').textContent = 'до ' + service.max_capacity + ' чел.';
                document.getElementById('max-capacity').textContent = service.max_capacity;

                // Информация о времени бронирования
                const bookingTimeBadge = document.getElementById('service-booking-time');
                if (service.min_booking_hours > 0) {
                    bookingTimeBadge.textContent = 'Бронировать за ' + service.min_booking_hours + ' ч.';
                    bookingTimeBadge.style.display = 'inline-block';
                } else {
                    bookingTimeBadge.style.display = 'none';
                }

                // Устанавливаем максимальное значение для участников
                if (participantsInput) {
                    participantsInput.max = service.max_capacity;
                    if (participantsInput.value > service.max_capacity) {
                        participantsInput.value = service.max_capacity;
                    }
                }

                serviceInfo.style.display = 'block';
                updateTotalPrice();
                updateTimeConstraints(service);
                updateBookingTimeInfo(service);
            } else {
                if (serviceInfo) serviceInfo.style.display = 'none';
            }
        }

        // Функция обновления ограничений по времени
        function updateTimeConstraints(service) {
            if (!service || !bookingDateInput) return;

            const now = new Date();

            if (service.min_booking_hours > 0) {
                // Рассчитываем минимальное доступное время
                const minDatetime = new Date(now.getTime() + (service.min_booking_hours * 60 * 60 * 1000));
                const minDate = minDatetime.toISOString().split('T')[0];

                // Устанавливаем минимальную дату
                bookingDateInput.min = minDate;

                // Если текущая дата меньше минимальной, устанавливаем минимальную
                if (bookingDateInput.value && bookingDateInput.value < minDate) {
                    bookingDateInput.value = minDate;
                }

                // Если выбранная дата сегодня, устанавливаем минимальное время
                if (bookingDateInput.value === minDate && startTimeInput) {
                    // Рассчитываем минимальное время
                    let minHour = minDatetime.getHours();
                    let minMinute = minDatetime.getMinutes();

                    // Округляем до ближайших 15 минут в большую сторону
                    minMinute = Math.ceil(minMinute / 15) * 15;
                    if (minMinute >= 60) {
                        minHour += 1;
                        minMinute = 0;
                    }

                    const minTime = `${minHour.toString().padStart(2, '0')}:${minMinute.toString().padStart(2, '0')}`;
                    startTimeInput.min = minTime;

                    // Если текущее время меньше минимального, устанавливаем минимальное
                    if (startTimeInput.value && startTimeInput.value < minTime) {
                        startTimeInput.value = minTime;
                    }
                } else if (startTimeInput) {
                    // Для будущих дат снимаем ограничение
                    startTimeInput.min = '00:00';
                }
            }
        }

        // Функция обновления информации о времени бронирования
        function updateBookingTimeInfo(service) {
            const bookingTimeInfo = document.getElementById('booking-time-info');
            const minBookingTimeText = document.getElementById('min-booking-time-text');
            const currentBookingTime = document.getElementById('current-booking-time');
            const availableTimeMsg = document.getElementById('available-booking-time');
            const unavailableTimeMsg = document.getElementById('unavailable-booking-time');

            if (!service || !bookingDateInput || !bookingDateInput.value || !startTimeInput || !startTimeInput.value) {
                if (bookingTimeInfo) bookingTimeInfo.style.display = 'none';
                return;
            }

            const selectedDatetime = new Date(`${bookingDateInput.value}T${startTimeInput.value}`);
            const now = new Date();

            // Текст о минимальном времени бронирования
            if (service.min_booking_hours > 0) {
                minBookingTimeText.textContent =
                    `Эту услугу можно бронировать за ${service.min_booking_hours} часов до времени посещения.`;
            } else {
                minBookingTimeText.textContent = 'Эту услугу можно бронировать в любое время.';
            }

            // Форматируем выбранное время
            const selectedDateStr = selectedDatetime.toLocaleDateString('ru-RU', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
            const selectedTimeStr = selectedDatetime.toLocaleTimeString('ru-RU', {
                hour: '2-digit',
                minute: '2-digit'
            });
            currentBookingTime.textContent = `Выбранное время: ${selectedDateStr} ${selectedTimeStr}`;

            // Проверяем доступность времени
            if (service.min_booking_hours > 0) {
                const minBookingDatetime = new Date(now.getTime() + (service.min_booking_hours * 60 * 60 * 1000));

                if (selectedDatetime < minBookingDatetime) {
                    // Время недоступно
                    availableTimeMsg.style.display = 'none';
                    unavailableTimeMsg.style.display = 'block';

                    const minTimeStr = minBookingDatetime.toLocaleString('ru-RU', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    unavailableTimeMsg.innerHTML =
                        `⚠ Это время пока недоступно для бронирования. <br>Можно будет забронировать после ${minTimeStr}`;

                    bookingTimeInfo.className = 'alert alert-warning mb-4';
                } else {
                    // Время доступно
                    availableTimeMsg.style.display = 'block';
                    unavailableTimeMsg.style.display = 'none';
                    availableTimeMsg.textContent = '✓ Это время доступно для бронирования';
                    bookingTimeInfo.className = 'alert alert-info mb-4';
                }
            } else {
                // Можно бронировать в любое время
                availableTimeMsg.style.display = 'block';
                unavailableTimeMsg.style.display = 'none';
                availableTimeMsg.textContent = '✓ Эта услуга доступна для бронирования в любое время';
                bookingTimeInfo.className = 'alert alert-info mb-4';
            }

            bookingTimeInfo.style.display = 'block';
        }

        // Функция расчета итоговой стоимости
        function updateTotalPrice() {
            const serviceId = serviceSelect.value;
            const participants = parseInt(participantsInput.value) || 1;
            const totalPriceSpan = document.getElementById('total-price');

            if (serviceId && serviceData[serviceId]) {
                const service = serviceData[serviceId];
                const totalPrice = service.price * participants;
                totalPriceSpan.textContent = totalPrice.toLocaleString('ru-RU');
            } else {
                totalPriceSpan.textContent = '0';
            }
        }

        // Функция расчета времени окончания
        function updateEndTime() {
            const serviceId = serviceSelect.value;
            const endTimeDiv = document.getElementById('end-time');
            const endTimeValue = document.getElementById('end-time-value');

            if (serviceId && serviceData[serviceId] && startTimeInput && startTimeInput.value) {
                const service = serviceData[serviceId];
                const startTime = startTimeInput.value;

                // Расчет времени окончания
                const [hours, minutes] = startTime.split(':').map(Number);
                let endHours = hours + Math.floor(service.duration / 60);
                let endMinutes = minutes + (service.duration % 60);

                if (endMinutes >= 60) {
                    endHours += 1;
                    endMinutes -= 60;
                }

                if (endHours >= 24) {
                    endHours -= 24;
                }

                const endTimeStr = endHours.toString().padStart(2, '0') + ':' +
                                   endMinutes.toString().padStart(2, '0');
                endTimeValue.textContent = endTimeStr;
                endTimeDiv.style.display = 'block';
            } else {
                if (endTimeDiv) endTimeDiv.style.display = 'none';
            }
        }

        // События
        if (serviceSelect) {
            serviceSelect.addEventListener('change', updateServiceInfo);
        }

        if (participantsInput) {
            participantsInput.addEventListener('input', updateTotalPrice);
        }

        if (startTimeInput) {
            startTimeInput.addEventListener('change', function() {
                updateEndTime();
                if (serviceSelect.value) {
                    updateBookingTimeInfo(serviceData[serviceSelect.value]);
                }
            });
        }

        if (bookingDateInput) {
            bookingDateInput.addEventListener('change', function() {
                if (serviceSelect.value) {
                    updateBookingTimeInfo(serviceData[serviceSelect.value]);
                }
            });
        }

        // Инициализация
        if (serviceSelect.value) {
            updateServiceInfo();
        }
        updateTotalPrice();

        // Форматирование телефона
        const phoneInput = document.getElementById('{{ form.new_phone.id_for_label }}');
        if (phoneInput) {
            phoneInput.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');

                if (value.startsWith('7') || value.startsWith('8')) {
                    value = value.substring(1);
                }

                if (value.length > 0) {
                    let formatted = '+7 ';

                    if (value.length > 0) {
                        formatted += '(' + value.substring(0, 3);
                    }
                    if (value.length > 3) {
                        formatted += ') ' + value.substring(3, 6);
                    }
                    if (value.length > 6) {
                        formatted += '-' + value.substring(6, 8);
                    }
                    if (value.length > 8) {
                        formatted += '-' + value.substring(8, 10);
                    }

                    e.target.value = formatted;
                }
            });
        }
    });
</script>
{% endblock %}