{% extends 'service/base.html' %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-md-12 col-lg-10">
            <div class="card shadow">
                <div class="card-header bg-white py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">{{ title }}</h5>
                        <a href="{% url 'service_booking_list' %}" class="btn btn-sm btn-outline-secondary">
                            <i class="fas fa-arrow-left"></i> –ù–∞–∑–∞–¥
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    <form method="post" novalidate id="booking-form">
                        {% csrf_token %}

                        {% if form.non_field_errors %}
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-circle me-2"></i>
                            {% for error in form.non_field_errors %}
                            {{ error }}
                            {% endfor %}
                        </div>
                        {% endif %}

                        <div class="row">
                            <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ - –í—ã–±–æ—Ä/–°–æ–∑–¥–∞–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞ -->
                            <div class="col-md-6">
                                <div class="card mb-4">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0">
                                            <i class="fas fa-user me-2"></i>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª–∏–µ–Ω—Ç–µ
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –º–µ–∂–¥—É –≤—ã–±–æ—Ä–æ–º –∏ —Å–æ–∑–¥–∞–Ω–∏–µ–º -->
                                        <div class="mb-3">
                                            <div class="form-check form-switch">
                                                {{ form.new_customer }}
                                                <label class="form-check-label" for="{{ form.new_customer.id_for_label }}">
                                                    <strong>–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞</strong>
                                                </label>
                                            </div>
                                            <small class="form-text text-muted">
                                                –û—Ç–º–µ—Ç—å—Ç–µ, —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞, –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑ —Å–ø–∏—Å–∫–∞
                                            </small>
                                        </div>
                                        <!-- –í—ã–±–æ—Ä —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ -->
                                        <div id="existing-customer-section">
                                            <div class="mb-3">
                                                <label for="{{ form.customer.id_for_label }}" class="form-label fw-semibold">
                                                    –í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞ *
                                                </label>
                                                {{ form.customer }}
                                                {% if form.customer.errors %}
                                                <div class="invalid-feedback d-block">
                                                    {{ form.customer.errors }}
                                                </div>
                                                {% endif %}
                                                <small class="form-text text-muted">
                                                    <a href="{% url 'customer_list' %}" target="_blank">
                                                        <i class="fas fa-external-link-alt"></i> –í—Å–µ –∫–ª–∏–µ–Ω—Ç—ã
                                                    </a>
                                                </small>
                                            </div>
                                        </div>

                                        <!-- –§–æ—Ä–º–∞ –Ω–æ–≤–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ (—Å–∫—Ä—ã—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
                                        <div id="new-customer-section" style="display: none;">
                                            <div class="alert alert-info mb-3">
                                                <i class="fas fa-info-circle me-2"></i>
                                                –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –Ω–æ–≤–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞. –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è: –ò–º—è, –§–∞–º–∏–ª–∏—è, –¢–µ–ª–µ—Ñ–æ–Ω.
                                            </div>

                                            <div class="row">
                                                <div class="col-md-6 mb-3">
                                                    <label for="{{ form.new_first_name.id_for_label }}" class="form-label">
                                                        –ò–º—è *
                                                    </label>
                                                    {{ form.new_first_name }}
                                                    {% if form.new_first_name.errors %}
                                                    <div class="invalid-feedback d-block">
                                                        {{ form.new_first_name.errors }}
                                                    </div>
                                                    {% endif %}
                                                </div>

                                                <div class="col-md-6 mb-3">
                                                    <label for="{{ form.new_last_name.id_for_label }}" class="form-label">
                                                        –§–∞–º–∏–ª–∏—è *
                                                    </label>
                                                    {{ form.new_last_name }}
                                                    {% if form.new_last_name.errors %}
                                                    <div class="invalid-feedback d-block">
                                                        {{ form.new_last_name.errors }}
                                                    </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col-md-6 mb-3">
                                                    <label for="{{ form.new_phone.id_for_label }}" class="form-label">
                                                        –¢–µ–ª–µ—Ñ–æ–Ω *
                                                    </label>
                                                    {{ form.new_phone }}
                                                    {% if form.new_phone.errors %}
                                                    <div class="invalid-feedback d-block">
                                                        {{ form.new_phone.errors }}
                                                    </div>
                                                    {% endif %}
                                                    <small class="form-text text-muted">
                                                        –§–æ—Ä–º–∞—Ç: +7 (999) 123-45-67
                                                    </small>
                                                </div>

                                                <div class="col-md-6 mb-3">
                                                    <label for="{{ form.new_email.id_for_label }}" class="form-label">
                                                        Email
                                                    </label>
                                                    {{ form.new_email }}
                                                    {% if form.new_email.errors %}
                                                    <div class="invalid-feedback d-block">
                                                        {{ form.new_email.errors }}
                                                    </div>
                                                    {% endif %}
                                                </div>
                                            </div>

                                            <div class="row">
                                                <div class="col-md-6 mb-3">
                                                    <label for="{{ form.new_passport_number.id_for_label }}" class="form-label">
                                                        –ù–æ–º–µ—Ä –ø–∞—Å–ø–æ—Ä—Ç–∞
                                                    </label>
                                                    {{ form.new_passport_number }}
                                                    {% if form.new_passport_number.errors %}
                                                    <div class="invalid-feedback d-block">
                                                        {{ form.new_passport_number.errors }}
                                                    </div>
                                                    {% endif %}
                                                </div>

                                                <div class="col-md-6 mb-3">
                                                    <label for="{{ form.new_birthday.id_for_label }}" class="form-label">
                                                        –î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è
                                                    </label>
                                                    {{ form.new_birthday }}
                                                    {% if form.new_birthday.errors %}
                                                    <div class="invalid-feedback d-block">
                                                        {{ form.new_birthday.errors }}
                                                    </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ - –í—ã–±–æ—Ä —É—Å–ª—É–≥–∏ –∏ –≤—Ä–µ–º–µ–Ω–∏ -->
                            <div class="col-md-6">
                                <div class="card mb-4">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0">
                                            <i class="fas fa-spa me-2"></i>–í—ã–±–æ—Ä —É—Å–ª—É–≥–∏ –∏ –≤—Ä–µ–º–µ–Ω–∏
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label for="{{ form.service.id_for_label }}" class="form-label fw-semibold">
                                                –£—Å–ª—É–≥–∞ *
                                            </label>
                                            {{ form.service }}
                                            {% if form.service.errors %}
                                            <div class="invalid-feedback d-block">
                                                {{ form.service.errors }}
                                            </div>
                                            {% endif %}
                                            <small class="form-text text-muted">
                                                <a href="{% url 'service_list' %}" target="_blank">
                                                    <i class="fas fa-external-link-alt"></i> –í—Å–µ —É—Å–ª—É–≥–∏
                                                </a>
                                            </small>
                                        </div>

                                        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± —É—Å–ª—É–≥–µ -->
                                        <div id="service-info" class="card border-primary mt-3" style="display: none;">
                                            <div class="card-body p-3">
                                                <div class="d-flex justify-content-between align-items-start">
                                                    <div>
                                                        <h6 class="card-title mb-1" id="service-name"></h6>
                                                        <p class="card-text text-muted small mb-2" id="service-description"></p>
                                                        <div class="d-flex align-items-center gap-2 flex-wrap">
                                                            <span class="badge bg-info" id="service-duration"></span>
                                                            <span class="badge bg-secondary" id="service-capacity"></span>
                                                            <span class="badge bg-warning" id="service-booking-time" style="display: none;"></span>
                                                        </div>
                                                    </div>
                                                    <div class="text-end">
                                                        <div class="text-success fw-bold fs-5" id="service-price"></div>
                                                        <small class="text-muted">–∑–∞ 1 —á–µ–ª.</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row mt-3">
                                            <div class="col-md-6 mb-3">
                                                <label for="{{ form.booking_date.id_for_label }}" class="form-label fw-semibold">
                                                    –î–∞—Ç–∞ –∑–∞–ø–∏—Å–∏ *
                                                </label>
                                                {{ form.booking_date }}
                                                {% if form.booking_date.errors %}
                                                <div class="invalid-feedback d-block">
                                                    {{ form.booking_date.errors }}
                                                </div>
                                                {% endif %}
                                            </div>

                                            <div class="col-md-6 mb-3">
                                                <label for="{{ form.start_time.id_for_label }}" class="form-label fw-semibold">
                                                    –í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ *
                                                </label>
                                                {{ form.start_time }}
                                                {% if form.start_time.errors %}
                                                <div class="invalid-feedback d-block">
                                                    {{ form.start_time.errors }}
                                                </div>
                                                {% endif %}
                                                <div id="end-time" class="mt-2 small text-muted" style="display: none;">
                                                    <i class="fas fa-hourglass-end me-1"></i>
                                                    –û–∫–æ–Ω—á–∞–Ω–∏–µ: <span id="end-time-value" class="fw-semibold"></span>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="{{ form.participants.id_for_label }}" class="form-label fw-semibold">
                                                    –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
                                                </label>
                                                <div class="input-group">
                                                    {{ form.participants }}
                                                    <span class="input-group-text">—á–µ–ª.</span>
                                                </div>
                                                {% if form.participants.errors %}
                                                <div class="invalid-feedback d-block">
                                                    {{ form.participants.errors }}
                                                </div>
                                                {% endif %}
                                                <small class="form-text text-muted" id="max-capacity-info">
                                                    –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ: <span id="max-capacity" class="fw-semibold">1</span> —á–µ–ª–æ–≤–µ–∫
                                                </small>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="{{ form.status.id_for_label }}" class="form-label fw-semibold">
                                                    –°—Ç–∞—Ç—É—Å –∑–∞–ø–∏—Å–∏ *
                                                </label>
                                                {{ form.status }}
                                                {% if form.status.errors %}
                                                <div class="invalid-feedback d-block">
                                                    {{ form.status.errors }}
                                                </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤—Ä–µ–º–µ–Ω–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è -->
                        <div id="booking-time-info" class="alert alert-warning mb-4" style="display: none;">
                            <div class="d-flex">
                                <div class="me-3">
                                    <i class="fas fa-clock"></i>
                                </div>
                                <div>
                                    <h6 class="alert-heading mb-1">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏</h6>
                                    <p class="mb-0" id="min-booking-time-text"></p>
                                    <p class="mb-0 mt-1 small" id="current-booking-time"></p>
                                    <p class="mb-0 mt-1 small text-success" id="available-booking-time" style="display: none;">
                                        ‚úì –≠—Ç–æ –≤—Ä–µ–º—è –¥–æ—Å—Ç—É–ø–Ω–æ –¥–ª—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
                                    </p>
                                    <p class="mb-0 mt-1 small text-danger" id="unavailable-booking-time" style="display: none;">
                                        ‚ö† –≠—Ç–æ –≤—Ä–µ–º—è –ø–æ–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ –¥–ª—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è -->
                        <div class="row">
                            <div class="col-md-6 mb-4">
                                <div class="card">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0">
                                            <i class="fas fa-comment-medical me-2"></i>–û—Å–æ–±—ã–µ –ø–æ–∂–µ–ª–∞–Ω–∏—è
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        {{ form.special_requests }}
                                        {% if form.special_requests.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.special_requests.errors }}
                                        </div>
                                        {% endif %}
                                        <small class="form-text text-muted">
                                            –ü—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è –∏ –ø–æ–∂–µ–ª–∞–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞ –∫ —É—Å–ª—É–≥–µ
                                        </small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-4">
                                <div class="card">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0">
                                            <i class="fas fa-sticky-note me-2"></i>–ü—Ä–∏–º–µ—á–∞–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        {{ form.notes }}
                                        {% if form.notes.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.notes.errors }}
                                        </div>
                                        {% endif %}
                                        <small class="form-text text-muted">
                                            –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –∑–∞–º–µ—Ç–∫–∏ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–∏ –æ—Ç–µ–ª—è
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å -->
                        <div class="alert alert-success mb-4">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="alert-heading mb-1">
                                        <i class="fas fa-calculator me-2"></i>–ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å
                                    </h6>
                                    <p class="mb-0">
                                        <small class="text-muted">
                                            –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ —É—Å–ª—É–≥–∏ –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
                                        </small>
                                    </p>
                                </div>
                                <div class="text-end">
                                    <div class="fs-4 fw-bold text-success" id="total-price">0</div>
                                    <small class="text-muted">—Ä—É–±–ª–µ–π</small>
                                </div>
                            </div>
                        </div>

                        <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
                        <div class="d-flex justify-content-between mt-4 pt-3 border-top">
                            <a href="{% url 'service_booking_list' %}" class="btn btn-secondary">
                                <i class="fas fa-times me-2"></i>–û—Ç–º–µ–Ω–∞
                            </a>
                            <div>
                                <button type="submit" name="save_and_new" value="true" class="btn btn-outline-primary me-2">
                                    <i class="fas fa-save me-2"></i>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –¥–æ–±–∞–≤–∏—Ç—å –µ—â–µ
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-check me-2"></i>–°–æ–∑–¥–∞—Ç—å –∑–∞–ø–∏—Å—å
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .form-control, .form-select, textarea.form-control {
        border-radius: 8px;
        border: 1px solid #dee2e6;
        padding: 0.75rem;
        transition: all 0.3s ease;
    }

    .form-control:focus, .form-select:focus, textarea.form-control:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        transform: translateY(-1px);
    }

    .form-check-input:checked {
        background-color: #667eea;
        border-color: #667eea;
    }

    .form-check-input:focus {
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    }
    .form-label {
        color: #2c3e50;
        margin-bottom: 0.5rem;
        font-weight: 500;
    }

    .fw-semibold {
        font-weight: 600;
    }

    .card-header.bg-light {
        background-color: #f8f9fa !important;
    }

    .badge {
        font-weight: 500;
        padding: 0.35em 0.65em;
    }

    .input-group-text {
        background-color: #f8f9fa;
        border-color: #dee2e6;
    }

    .alert {
        border-radius: 10px;
        border-left: 4px solid;
    }

    .alert-success {
        border-left-color: #2e7d32;
    }

    .alert-warning {
        border-left-color: #ef6c00;
    }

    .alert-info {
        border-left-color: #1976d2;
    }

    .card.border-primary {
        border-color: #667eea !important;
        border-width: 2px;
    }

    .form-switch .form-check-input {
        width: 3em;
        height: 1.5em;
        margin-right: 0.5rem;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // –î–∞–Ω–Ω—ã–µ –æ–± —É—Å–ª—É–≥–∞—Ö
        const serviceData = {{ services_json|safe }};

        // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
        const newCustomerCheckbox = document.getElementById('{{ form.new_customer.id_for_label }}');
        const existingCustomerSection = document.getElementById('existing-customer-section');
        const newCustomerSection = document.getElementById('new-customer-section');
        const existingCustomerSelect = document.getElementById('{{ form.customer.id_for_label }}');
        const serviceSelect = document.getElementById('{{ form.service.id_for_label }}');
        const participantsInput = document.getElementById('{{ form.participants.id_for_label }}');
        const bookingDateInput = document.getElementById('{{ form.booking_date.id_for_label }}');
        const startTimeInput = document.getElementById('{{ form.start_time.id_for_label }}');

        // –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –Ω–æ–≤–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
        if (newCustomerCheckbox) {
            newCustomerCheckbox.addEventListener('change', function() {
                if (this.checked) {
                    existingCustomerSection.style.display = 'none';
                    newCustomerSection.style.display = 'block';

                    // –î–µ–ª–∞–µ–º –ø–æ–ª—è –Ω–æ–≤–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–º–∏
                    const newCustomerFields = newCustomerSection.querySelectorAll('input');
                    newCustomerFields.forEach(field => {
                        if (field.id.includes('new_')) {
                            if (field.id.includes('first_name') ||
                                field.id.includes('last_name') ||
                                field.id.includes('phone')) {
                                field.required = true;
                            }
                        }
                    });

                    // –î–µ–ª–∞–µ–º –≤—ã–±–æ—Ä —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ –Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–º
                    if (existingCustomerSelect) {
                        existingCustomerSelect.required = false;
                    }
                } else {
                    existingCustomerSection.style.display = 'block';
                    newCustomerSection.style.display = 'none';

                    // –î–µ–ª–∞–µ–º –≤—ã–±–æ—Ä —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–º
                    if (existingCustomerSelect) {
                        existingCustomerSelect.required = true;
                    }
                }
            });

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            if (newCustomerCheckbox.checked) {
                existingCustomerSection.style.display = 'none';
                newCustomerSection.style.display = 'block';
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± —É—Å–ª—É–≥–µ
        function updateServiceInfo() {
            const serviceId = serviceSelect.value;
            const serviceInfo = document.getElementById('service-info');

            if (serviceId && serviceData[serviceId]) {
                const service = serviceData[serviceId];
    document.getElementById('service-name').textContent = service.name;
                document.getElementById('service-description').textContent = service.description;
                document.getElementById('service-price').textContent = service.price + ' —Ä—É–±.';

                // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
                const hours = Math.floor(service.duration / 60);
                const minutes = service.duration % 60;
                let durationText = '';
                if (hours > 0) durationText += hours + ' —á ';
                if (minutes > 0) durationText += minutes + ' –º–∏–Ω';
                document.getElementById('service-duration').textContent = durationText.trim();

                document.getElementById('service-capacity').textContent = '–¥–æ ' + service.max_capacity + ' —á–µ–ª.';
                document.getElementById('max-capacity').textContent = service.max_capacity;

                // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤—Ä–µ–º–µ–Ω–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
                const bookingTimeBadge = document.getElementById('service-booking-time');
                if (service.min_booking_hours > 0) {
                    bookingTimeBadge.textContent = '–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –∑–∞ ' + service.min_booking_hours + ' —á.';
                    bookingTimeBadge.style.display = 'inline-block';
                } else {
                    bookingTimeBadge.style.display = 'none';
                }

                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
                if (participantsInput) {
                    participantsInput.max = service.max_capacity;
                    if (participantsInput.value > service.max_capacity) {
                        participantsInput.value = service.max_capacity;
                    }
                }

                serviceInfo.style.display = 'block';
                updateTotalPrice();
                updateTimeConstraints(service);
                updateBookingTimeInfo(service);
            } else {
                if (serviceInfo) serviceInfo.style.display = 'none';
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –ø–æ –≤—Ä–µ–º–µ–Ω–∏
        function updateTimeConstraints(service) {
            if (!service || !bookingDateInput) return;

            const now = new Date();

            if (service.min_booking_hours > 0) {
                // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –¥–æ—Å—Ç—É–ø–Ω–æ–µ –≤—Ä–µ–º—è
                const minDatetime = new Date(now.getTime() + (service.min_booking_hours * 60 * 60 * 1000));
                const minDate = minDatetime.toISOString().split('T')[0];

                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é –¥–∞—Ç—É
                bookingDateInput.min = minDate;

                // –ï—Å–ª–∏ —Ç–µ–∫—É—â–∞—è –¥–∞—Ç–∞ –º–µ–Ω—å—à–µ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é
                if (bookingDateInput.value && bookingDateInput.value < minDate) {
                    bookingDateInput.value = minDate;
                }

                // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–Ω–∞—è –¥–∞—Ç–∞ —Å–µ–≥–æ–¥–Ω—è, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è
                if (bookingDateInput.value === minDate && startTimeInput) {
                    // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è
                    let minHour = minDatetime.getHours();
                    let minMinute = minDatetime.getMinutes();

                    // –û–∫—Ä—É–≥–ª—è–µ–º –¥–æ –±–ª–∏–∂–∞–π—à–∏—Ö 15 –º–∏–Ω—É—Ç –≤ –±–æ–ª—å—à—É—é —Å—Ç–æ—Ä–æ–Ω—É
                    minMinute = Math.ceil(minMinute / 15) * 15;
                    if (minMinute >= 60) {
                        minHour += 1;
                        minMinute = 0;
                    }

                    const minTime = ${minHour.toString().padStart(2, '0')}:${minMinute.toString().padStart(2, '0')};
                    startTimeInput.min = minTime;
    // –ï—Å–ª–∏ —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è –º–µ–Ω—å—à–µ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ
                    if (startTimeInput.value && startTimeInput.value < minTime) {
                        startTimeInput.value = minTime;
                    }
                } else if (startTimeInput) {
                    // –î–ª—è –±—É–¥—É—â–∏—Ö –¥–∞—Ç —Å–Ω–∏–º–∞–µ–º –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ
                    startTimeInput.min = '00:00';
                }
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –≤—Ä–µ–º–µ–Ω–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
        function updateBookingTimeInfo(service) {
            const bookingTimeInfo = document.getElementById('booking-time-info');
            const minBookingTimeText = document.getElementById('min-booking-time-text');
            const currentBookingTime = document.getElementById('current-booking-time');
            const availableTimeMsg = document.getElementById('available-booking-time');
            const unavailableTimeMsg = document.getElementById('unavailable-booking-time');

            if (!service ‚†µ‚†∫‚†∫‚†µ‚†û‚†ü‚†µ‚†û‚†µ‚†∫‚†ü‚†µ‚†µ‚†û‚†∫‚†∫‚†µ‚†ü‚†û !bookingDateInput.value ‚†û‚†µ‚†µ‚†µ‚†û‚†µ‚†∫‚†û‚†û‚†û‚†û‚†∫‚†ü‚†∫‚†µ‚†û‚†µ !startTimeInput.value) {
                if (bookingTimeInfo) bookingTimeInfo.style.display = 'none';
                return;
            }

            const selectedDatetime = new Date(`${bookingDateInput.value}T${startTimeInput.value}`);
            const now = new Date();

            // –¢–µ–∫—Å—Ç –æ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
            if (service.min_booking_hours > 0) {
                minBookingTimeText.textContent =
                    –≠—Ç—É —É—Å–ª—É–≥—É –º–æ–∂–Ω–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –∑–∞ ${service.min_booking_hours} —á–∞—Å–æ–≤ –¥–æ –≤—Ä–µ–º–µ–Ω–∏ –ø–æ—Å–µ—â–µ–Ω–∏—è.;
            } else {
                minBookingTimeText.textContent = '–≠—Ç—É —É—Å–ª—É–≥—É –º–æ–∂–Ω–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –≤ –ª—é–±–æ–µ –≤—Ä–µ–º—è.';
            }

            // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è
            const selectedDateStr = selectedDatetime.toLocaleDateString('ru-RU', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
            const selectedTimeStr = selectedDatetime.toLocaleTimeString('ru-RU', {
                hour: '2-digit',
                minute: '2-digit'
            });
            currentBookingTime.textContent = –í—ã–±—Ä–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è: ${selectedDateStr} ${selectedTimeStr};

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –≤—Ä–µ–º–µ–Ω–∏
            if (service.min_booking_hours > 0) {
                const minBookingDatetime = new Date(now.getTime() + (service.min_booking_hours * 60 * 60 * 1000));

                if (selectedDatetime < minBookingDatetime) {
                    // –í—Ä–µ–º—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ
                    availableTimeMsg.style.display = 'none';
                    unavailableTimeMsg.style.display = 'block';

                    const minTimeStr = minBookingDatetime.toLocaleString('ru-RU', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    unavailableTimeMsg.innerHTML =
                        ‚ö† –≠—Ç–æ –≤—Ä–µ–º—è –ø–æ–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ –¥–ª—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è. <br>–ú–æ–∂–Ω–æ –±—É–¥–µ—Ç –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Å–ª–µ ${minTimeStr};

                    bookingTimeInfo.className = 'alert alert-warning mb-4';
                } else {
                    // –í—Ä–µ–º—è –¥–æ—Å—Ç—É–ø–Ω–æ
                    availableTimeMsg.style.display = 'block';
                    unavailableTimeMsg.style.display = 'none';
                    availableTimeMsg.textContent = '‚úì –≠—Ç–æ –≤—Ä–µ–º—è –¥–æ—Å—Ç—É–ø–Ω–æ –¥–ª—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è';
                    bookingTimeInfo.className = 'alert alert-info mb-4';
                }
            } else {
                // –ú–æ–∂–Ω–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –≤ –ª—é–±–æ–µ –≤—Ä–µ–º—è
                availableTimeMsg.style.display = 'block';
                unavailableTimeMsg.style.display = 'none';
                availableTimeMsg.textContent = '‚úì –≠—Ç–∞ —É—Å–ª—É–≥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ –¥–ª—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –≤ –ª—é–±–æ–µ –≤—Ä–µ–º—è';
                bookingTimeInfo.className = 'alert alert-info mb-4';
            }

            bookingTimeInfo.style.display = 'block';
        }
    // –§—É–Ω–∫—Ü–∏—è —Ä–∞—Å—á–µ—Ç–∞ –∏—Ç–æ–≥–æ–≤–æ–π —Å—Ç–æ–∏–º–æ—Å—Ç–∏
        function updateTotalPrice() {
            const serviceId = serviceSelect.value;
            const participants = parseInt(participantsInput.value) || 1;
            const totalPriceSpan = document.getElementById('total-price');

            if (serviceId && serviceData[serviceId]) {
                const service = serviceData[serviceId];
                const totalPrice = service.price * participants;
                totalPriceSpan.textContent = totalPrice.toLocaleString('ru-RU');
            } else {
                totalPriceSpan.textContent = '0';
            }
        }

        // –§—É–Ω–∫—Ü–∏—è —Ä–∞—Å—á–µ—Ç–∞ –≤—Ä–µ–º–µ–Ω–∏ –æ–∫–æ–Ω—á–∞–Ω–∏—è
        function updateEndTime() {
            const serviceId = serviceSelect.value;
            const endTimeDiv = document.getElementById('end-time');
            const endTimeValue = document.getElementById('end-time-value');

            if (serviceId && serviceData[serviceId] && startTimeInput && startTimeInput.value) {
                const service = serviceData[serviceId];
                const startTime = startTimeInput.value;

                // –†–∞—Å—á–µ—Ç –≤—Ä–µ–º–µ–Ω–∏ –æ–∫–æ–Ω—á–∞–Ω–∏—è
                const [hours, minutes] = startTime.split(':').map(Number);
                let endHours = hours + Math.floor(service.duration / 60);
                let endMinutes = minutes + (service.duration % 60);

                if (endMinutes >= 60) {
                    endHours += 1;
                    endMinutes -= 60;
                }

                if (endHours >= 24) {
                    endHours -= 24;
                }

                const endTimeStr = endHours.toString().padStart(2, '0') + ':' +
                                   endMinutes.toString().padStart(2, '0');
                endTimeValue.textContent = endTimeStr;
                endTimeDiv.style.display = 'block';
            } else {
                if (endTimeDiv) endTimeDiv.style.display = 'none';
            }
        }

        // –°–æ–±—ã—Ç–∏—è
        if (serviceSelect) {
            serviceSelect.addEventListener('change', updateServiceInfo);
        }

        if (participantsInput) {
            participantsInput.addEventListener('input', updateTotalPrice);
        }

        if (startTimeInput) {
            startTimeInput.addEventListener('change', function() {
                updateEndTime();
                if (serviceSelect.value) {
                    updateBookingTimeInfo(serviceData[serviceSelect.value]);
                }
            });
        }

        if (bookingDateInput) {
            bookingDateInput.addEventListener('change', function() {
                if (serviceSelect.value) {
                    updateBookingTimeInfo(serviceData[serviceSelect.value]);
                }
            });
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        if (serviceSelect.value) {
            updateServiceInfo();
        }
        updateTotalPrice();

        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
        const phoneInput = document.getElementById('{{ form.new_phone.id_for_label }}');
        if (phoneInput) {
            phoneInput.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');

                if (value.startsWith('7') || value.startsWith('8')) {
                    value = value.substring(1);
                }

                if (value.length > 0) {
                    let formatted = '+7 ';

                    if (value.length > 0) {
                        formatted += '(' + value.substring(0, 3);
                    }
                    if (value.length > 3) {
                        formatted += ') ' + value.substring(3, 6);
                    }
                    if (value.length > 6) {
                        formatted += '-' + value.substring(6, 8);
                    }
                    if (value.length > üòç {
                        formatted += '-' + value.substring(8, 10);
                    }

                    e.target.value = formatted;
                }
            });
        }
    });
</script>
{% endblock %}
