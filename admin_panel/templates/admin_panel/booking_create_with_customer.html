{% extends 'admin_panel/base.html' %}
{% load static %}

{% block content %}
<div class="booking-create-container">
    <div class="booking-header">
        <h1>üìã –ù–æ–≤–æ–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</h1>
        <p class="booking-subtitle">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–ª–∏–µ–Ω—Ç–µ –∏ –≤—ã–±–µ—Ä–∏—Ç–µ –Ω–æ–º–µ—Ä –¥–ª—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</p>
    </div>

    <!-- –®–∞–≥–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è -->
    <div class="booking-steps">
        <div class="step active">
            <span class="step-number">1</span>
            <span class="step-text">–í—ã–±–æ—Ä –¥–∞—Ç</span>
        </div>
        <div class="step {% if check_in_date and check_out_date %}active{% endif %}">
            <span class="step-number">2</span>
            <span class="step-text">–í—ã–±–æ—Ä –∫–ª–∏–µ–Ω—Ç–∞</span>
        </div>
        <div class="step">
            <span class="step-number">3</span>
            <span class="step-text">–í—ã–±–æ—Ä –Ω–æ–º–µ—Ä–∞</span>
        </div>
        <div class="step">
            <span class="step-number">4</span>
            <span class="step-text">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</span>
        </div>
    </div>

    <!-- –ë–ª–æ–∫ –ø–æ–∏—Å–∫–∞ —Å–≤–æ–±–æ–¥–Ω—ã—Ö –Ω–æ–º–µ—Ä–æ–≤ -->
    <div class="search-block card">
        <div class="card-header">
            <h3><i class="fas fa-calendar-alt"></i> –í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—ã –ø—Ä–æ–∂–∏–≤–∞–Ω–∏—è</h3>
        </div>
        <div class="card-body">
            <form method="get" class="search-form">
                <div class="date-range-picker">
                    <div class="date-input-group">
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-sign-in-alt"></i></span>
                            <input type="date" name="check_in" id="check_in" class="form-control"
                                   value="{{ check_in_date|default:'' }}" required
                                   min="{{ today|date:'Y-m-d' }}">
                            <label for="check_in" class="input-label">–î–∞—Ç–∞ –∑–∞–µ–∑–¥–∞</label>
                        </div>
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-sign-out-alt"></i></span>
                            <input type="date" name="check_out" id="check_out" class="form-control"
                                   value="{{ check_out_date|default:'' }}" required
                                   min="{{ today|date:'Y-m-d' }}">
                            <label for="check_out" class="input-label">–î–∞—Ç–∞ –≤—ã–µ–∑–¥–∞</label>
                        </div>
                    </div>
                    <button type="submit" class="btn-search-dates">
                        <i class="fas fa-search"></i> –ù–∞–π—Ç–∏ —Å–≤–æ–±–æ–¥–Ω—ã–µ –Ω–æ–º–µ—Ä–∞
                    </button>
                </div>
            </form>
        </div>
    </div>

    {% if check_in_date and check_out_date %}
    <div class="booking-content">
        <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª–∏–µ–Ω—Ç–µ -->
        <div class="booking-left-column">
            <!-- –í—ã–±–æ—Ä —Ç–∏–ø–∞ –∫–ª–∏–µ–Ω—Ç–∞ -->
            <div class="card customer-type-card">
                <div class="card-header">
                    <h4><i class="fas fa-users"></i> –í—ã–±–æ—Ä –∫–ª–∏–µ–Ω—Ç–∞</h4>
                </div>
                <div class="card-body">
                    <div class="customer-type-switch">
                        <div class="switch-buttons">
                            <button type="button" class="switch-btn {% if new_customer %}active{% endif %}"
                                    onclick="switchCustomerType('new')">
                                <i class="fas fa-user-plus"></i> –ù–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç
                            </button>
                            <button type="button" class="switch-btn {% if not new_customer %}active{% endif %}"
                                    onclick="switchCustomerType('existing')">
                                <i class="fas fa-user-check"></i> –°—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–ª–∏–µ–Ω—Ç
                            </button>
                        </div>

                        <!-- –°–∫—Ä—ã—Ç—ã–µ —Ä–∞–¥–∏–æ–∫–Ω–æ–ø–∫–∏ –¥–ª—è —Ñ–æ—Ä–º—ã -->
                        <input type="hidden" name="customer_option" id="customer_option"
                               value="{% if new_customer %}new{% else %}existing{% endif %}">
                    </div>

                    <!-- –ü–æ–∏—Å–∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ -->
                    <div id="existingCustomerSearch" class="customer-search-block"
                         style="display: {% if not new_customer %}block{% else %}none{% endif %};">
                        <div class="search-input-group">
                            <div class="input-with-icon">
                                <i class="fas fa-search"></i>
                                <input type="text" id="customerSearch" class="form-control"
                                       placeholder="–í–≤–µ–¥–∏—Ç–µ —Ñ–∞–º–∏–ª–∏—é, —Ç–µ–ª–µ—Ñ–æ–Ω –∏–ª–∏ email...">
                            </div>
                            <div id="customerSearchResults" class="search-results"></div>
                        </div>

                        <input type="hidden" name="customer_id" id="selectedCustomerId"
                               value="{% if not new_customer and customer_form.instance.id %}{{ customer_form.instance.id }}{% endif %}">

                        <!-- –ë—ã—Å—Ç—Ä—ã–µ –∫–ª–∏–µ–Ω—Ç—ã -->
                        {% if customers %}
                        <div class="quick-customers">
                            <h5><i class="fas fa-history"></i> –ù–µ–¥–∞–≤–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç—ã</h5>
                            <div class="quick-customers-grid">
                                {% for customer in customers %}
                                <div class="quick-customer-card"
                                     onclick="loadCustomerData({{ customer.id }})">
                                    <div class="customer-avatar">
                                        {{ customer.first_name|first }}{{ customer.last_name|first }}
                                    </div>
                                    <div class="customer-details">
                                        <div class="customer-name">{{ customer.last_name }} {{ customer.first_name }}</div>
                                        <div class="customer-phone">{{ customer.phone }}</div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- –§–æ—Ä–º–∞ –¥–∞–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–∞ -->
            <div class="card customer-form-card" id="customerInfoSection">
                <div class="card-header">
                    <h4><i class="fas fa-user-circle"></i> –î–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞</h4>
                </div>
                <div class="card-body">
                    <!-- –ò—Å–ø–æ–ª—å–∑—É–µ–º Django —Ñ–æ—Ä–º—É –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª–µ–π -->
                    <form id="customerForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="{{ customer_form.first_name.id_for_label }}" class="form-label">
                                    <i class="fas fa-user"></i> –ò–º—è *
                                </label>
                                {{ customer_form.first_name }}
                                <div id="first_name_errors" class="error-message">
                                    {% if customer_form.first_name.errors %}
                                    {% for error in customer_form.first_name.errors %}
                                    <span class="error-icon">‚ö†</span> {{ error }}
                                    {% endfor %}
                                    {% endif %}
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="{{ customer_form.last_name.id_for_label }}" class="form-label">
                                    <i class="fas fa-user"></i> –§–∞–º–∏–ª–∏—è *
                                </label>
                                {{ customer_form.last_name }}
                                <div id="last_name_errors" class="error-message">
                                    {% if customer_form.last_name.errors %}
                                    {% for error in customer_form.last_name.errors %}
                                    <span class="error-icon">‚ö†</span> {{ error }}
                                    {% endfor %}
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="{{ customer_form.email.id_for_label }}" class="form-label">
                                    <i class="fas fa-envelope"></i> Email *
                                </label>
                                {{ customer_form.email }}
                                <div id="email_errors" class="error-message">
                                    {% if customer_form.email.errors %}
                                    {% for error in customer_form.email.errors %}
                                    <span class="error-icon">‚ö†</span> {{ error }}
                                    {% endfor %}
                                    {% endif %}
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="{{ customer_form.phone.id_for_label }}" class="form-label">
                                    <i class="fas fa-phone"></i> –¢–µ–ª–µ—Ñ–æ–Ω *
                                </label>
                                {{ customer_form.phone }}
                                <div id="phone_errors" class="error-message">
                                    {% if customer_form.phone.errors %}
                                    {% for error in customer_form.phone.errors %}
                                    <span class="error-icon">‚ö†</span> {{ error }}
                                    {% endfor %}
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="{{ customer_form.passport_number.id_for_label }}" class="form-label">
                                    <i class="fas fa-passport"></i> –ü–∞—Å–ø–æ—Ä—Ç *
                                </label>
                                {{ customer_form.passport_number }}
                                <div id="passport_number_errors" class="error-message">
                                    {% if customer_form.passport_number.errors %}
                                    {% for error in customer_form.passport_number.errors %}
                                    <span class="error-icon">‚ö†</span> {{ error }}
                                    {% endfor %}
                                    {% endif %}
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="{{ customer_form.birthday.id_for_label }}" class="form-label">
                                    <i class="fas fa-birthday-cake"></i> –î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è *
                                </label>
                                <div class="date-input-wrapper">
                                    {{ customer_form.birthday }}
                                    <i class="fas fa-calendar date-icon"></i>
                                </div>
                                <div id="birthday_errors" class="error-message">
                                    {% if customer_form.birthday.errors %}
                                    {% for error in customer_form.birthday.errors %}
                                    <span class="error-icon">‚ö†</span> {{ error }}
                                    {% endfor %}
                                    {% endif %}
                                </div>
                                <div class="form-help">
                                    –û—Ç 18 –¥–æ 120 –ª–µ—Ç
                                </div>
                            </div>
                        </div>
                    </form>

                    <div id="customerSuggestions" class="suggestions-container"></div>
                </div>
            </div>
        </div>

        <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏ -->
        <div class="booking-right-column">
            <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è -->
            <div class="card booking-details-card">
                <div class="card-header">
                    <h4><i class="fas fa-hotel"></i> –î–µ—Ç–∞–ª–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</h4>
                </div>
                <div class="card-body">
                    <!-- –í—ã–±—Ä–∞–Ω–Ω—ã–µ –¥–∞—Ç—ã -->
                    <div class="selected-dates">
                        <div class="date-item">
                            <span class="date-label">–ó–∞–µ–∑–¥:</span>
                            <span class="date-value">{{ check_in_date }}</span>
                        </div>
                        <div class="date-item">
                            <span class="date-label">–í—ã–µ–∑–¥:</span>
                            <span class="date-value">{{ check_out_date }}</span>
                        </div>
                        <div class="date-item">
                            <span class="date-label">–ù–æ—á–µ–π:</span>
                            <span class="date-value" id="nights-count">0</span>
                        </div>
                    </div>

                    <!-- –°–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è –¥–∞—Ç -->
                    <input type="hidden" name="check_in_date" id="id_check_in_date" value="{{ check_in_date }}">
                    <input type="hidden" name="check_out_date" id="id_check_out_date" value="{{ check_out_date }}">

                    <!-- –í—ã–±–æ—Ä –Ω–æ–º–µ—Ä–∞ -->
                    <div class="form-group">
                        <label for="{{ booking_form.room.id_for_label }}" class="form-label">
                            <i class="fas fa-door-closed"></i> –í—ã–±–µ—Ä–∏—Ç–µ –Ω–æ–º–µ—Ä *
                        </label>
                        <div class="room-select-wrapper">
                            {{ booking_form.room }}
                            <i class="fas fa-chevron-down select-arrow"></i>
                        </div>
                        <div id="room_errors" class="error-message">
                            {% if booking_form.room.errors %}
                            {% for error in booking_form.room.errors %}
                            <span class="error-icon">‚ö†</span> {{ error }}
                            {% endfor %}
                            {% endif %}
                        </div>

                        {% if available_rooms %}
                        <div class="available-count">
                            <i class="fas fa-check-circle"></i>
                            –î–æ—Å—Ç—É–ø–Ω–æ –Ω–æ–º–µ—Ä–æ–≤: <strong>{{ available_rooms.count }}</strong>
                        </div>
                        {% endif %}
                    </div>

                    <!-- –û—Å–æ–±—ã–µ –ø–æ–∂–µ–ª–∞–Ω–∏—è -->
                    <div class="form-group">
                        <label for="{{ booking_form.special_requests.id_for_label }}" class="form-label">
                            <i class="fas fa-star"></i> –û—Å–æ–±—ã–µ –ø–æ–∂–µ–ª–∞–Ω–∏—è
                        </label>
                        {{ booking_form.special_requests }}
                    </div>

                    <!-- –†–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ -->
                    <div class="price-summary">
                        <h5><i class="fas fa-calculator"></i> –†–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏</h5>
                        <div class="price-breakdown">
                            <div class="price-item">
                                <span>–¶–µ–Ω–∞ –∑–∞ –Ω–æ—á—å:</span>
                                <span id="price-per-night">0 —Ä—É–±.</span>
                            </div>
                            <div class="price-item">
                                <span>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–æ—á–µ–π:</span>
                                <span id="nights-display">0</span>
                            </div>
                            <div class="price-divider"></div>
                            <div class="price-total">
                                <span>–ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ:</span>
                                <span id="total-price">0 —Ä—É–±.</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –°–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –Ω–æ–º–µ—Ä–æ–≤ -->
            {% if available_rooms %}
            <div class="card available-rooms-card">
                <div class="card-header">
                    <h4><i class="fas fa-bed"></i> –î–æ—Å—Ç—É–ø–Ω—ã–µ –Ω–æ–º–µ—Ä–∞ ({{ available_rooms.count }})</h4>
                </div>
                <div class="card-body">
                    <div class="rooms-grid">
                        {% for room in available_rooms %}
                        <div class="room-card {% if room.id == booking_form.room.value|add:'0' %}selected{% endif %}"
                             data-room-id="{{ room.id }}"
                             data-price="{{ room.room_type.price_per_night }}"
                             onclick="selectRoom({{ room.id }})">
                            <div class="room-header">
                                <div class="room-number">‚Ññ{{ room.room_number }}</div>
                                <div class="room-price">{{ room.room_type.price_per_night }} ‚ÇΩ/–Ω–æ—á—å</div>
                            </div>
                            <div class="room-type">{{ room.room_type.name }}</div>
                            <div class="room-details">
                                <span class="room-feature">
                                    <i class="fas fa-user-friends"></i> {{ room.room_type.capacity }} —á–µ–ª.
                                </span>
                                <span class="room-feature">
                                    <i class="fas fa-layer-group"></i> {{ room.floor }} —ç—Ç–∞–∂
                                </span>
                            </div>
                            {% if room.features %}
                            <div class="room-features">
                                <i class="fas fa-gem"></i> {{ room.features|truncatechars:50 }}
                            </div>
                            {% endif %}
                            <button type="button" class="select-room-btn">
                                <i class="fas fa-check"></i> –í—ã–±—Ä–∞—Ç—å
                            </button>
                        </div>
                        {% empty %}
                        <div class="no-rooms">
                            <i class="fas fa-bed fa-3x"></i>
                            <p>–ù–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –¥–∞—Ç—ã —Å–≤–æ–±–æ–¥–Ω—ã—Ö –Ω–æ–º–µ—Ä–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏—è -->
            <div class="action-buttons">
                <form method="post" class="booking-form" id="bookingForm">
                    {% csrf_token %}
                    <!-- –°–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è –¥–ª—è —Ç–∏–ø–∞ –∫–ª–∏–µ–Ω—Ç–∞ -->
                    <input type="hidden" name="customer_option" id="hidden_customer_option"
                           value="{% if new_customer %}new{% else %}existing{% endif %}">
                    <input type="hidden" name="customer_id" id="hidden_customer_id"
                           value="{% if not new_customer and customer_form.instance.id %}{{ customer_form.instance.id }}{% endif %}">

                    <div class="button-group">
                        <button type="submit" class="btn-create-booking">
                            <i class="fas fa-check-circle"></i> –°–æ–∑–¥–∞—Ç—å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
                        </button>
                        <a href="{% url 'rooms_dashboard' %}" class="btn-cancel">
                            <i class="fas fa-times"></i> –û—Ç–º–µ–Ω–∞
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<style>
    /* –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä */
    .booking-create-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    }

    /* –®–∞–≥–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è */
    .booking-steps {
        display: flex;
        justify-content: space-between;
        margin: 30px 0 40px;
        position: relative;
    }

    .booking-steps::before {
        content: '';
        position: absolute;
        top: 15px;
        left: 10%;
        right: 10%;
        height: 2px;
        background: #e0e0e0;
        z-index: 1;
    }

    .step {
        display: flex;
        flex-direction: column;
        align-items: center;
        position: relative;
        z-index: 2;
        flex: 1;
    }

    .step-number {
        width: 30px;
        height: 30px;
        background: #fff;
        border: 2px solid #e0e0e0;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        color: #999;
        margin-bottom: 8px;
    }

    .step.active .step-number {
        background: #667eea;
        border-color: #667eea;
        color: white;
    }

    .step-text {
        font-size: 14px;
        color: #999;
        text-align: center;
    }

    .step.active .step-text {
        color: #667eea;
        font-weight: 500;
    }

    /* –ó–∞–≥–æ–ª–æ–≤–æ–∫ */
    .booking-header {
        text-align: center;
        margin-bottom: 30px;
    }

    .booking-header h1 {
        color: #2c3e50;
        font-size: 32px;
        font-weight: 700;
        margin-bottom: 8px;
    }

    .booking-subtitle {
        color: #7f8c8d;
        font-size: 16px;
        margin: 0;
    }

    /* –ö–∞—Ä—Ç–æ—á–∫–∏ */
    .card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 20px rgba(0, 0, 0, 0.08);
        border: none;
        margin-bottom: 20px;
        overflow: hidden;
    }

    .card-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 16px 20px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .card-header h4 {
        margin: 0;
        font-size: 18px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .card-body {
        padding: 20px;
    }

    /* –ü–æ–∏—Å–∫ –¥–∞—Ç */
    .search-block {
        margin-bottom: 30px;
    }

    .date-range-picker {
        display: flex;
        gap: 20px;
        align-items: flex-end;
    }

    .date-input-group {
        display: flex;
        gap: 15px;
        flex: 1;
    }

    .input-group {
        flex: 1;
        position: relative;
    }

    .input-group-text {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-right: none;
    }

    .input-label {
        position: absolute;
        top: -20px;
        left: 0;
        font-size: 12px;
        color: #6c757d;
        font-weight: 500;
    }

    .btn-search-dates {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .btn-search-dates:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }

    /* –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç –≤ –¥–≤–µ –∫–æ–ª–æ–Ω–∫–∏ */
    .booking-content {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
        margin-top: 20px;
    }

    /* –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ */
    .booking-left-column {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    /* –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ç–∏–ø–∞ –∫–ª–∏–µ–Ω—Ç–∞ */
    .customer-type-switch {
        margin-bottom: 20px;
    }

    .switch-buttons {
        display: flex;
        gap: 10px;
        background: #f8f9fa;
        padding: 4px;
        border-radius: 8px;
    }

    .switch-btn {
        flex: 1;
        padding: 12px 16px;
        border: none;
        background: transparent;
        border-radius: 6px;
        font-weight: 500;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        transition: all 0.3s ease;
    }

    .switch-btn.active {
        background: white;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        color: #667eea;
    }

    /* –ü–æ–∏—Å–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤ */
    .customer-search-block {
        margin-top: 20px;
    }

    .search-input-group {
        position: relative;
    }

    .input-with-icon {
        position: relative;
    }

    .input-with-icon i {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: #6c757d;
    }

    .input-with-icon input {
        padding-left: 40px;
    }

    /* –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ */
    .search-results {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        max-height: 300px;
        overflow-y: auto;
        z-index: 1000;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        display: none;
    }

    .customer-result-item {
        padding: 12px 16px;
        border-bottom: 1px solid #f1f3f4;
        cursor: pointer;
        transition: background-color 0.2s;
    }

    .customer-result-item:hover {
        background-color: #f8f9fa;
    }

    .customer-result-name {
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 4px;
    }

    .customer-result-info {
        display: flex;
        gap: 15px;
        font-size: 13px;
        color: #6c757d;
    }

    /* –ë—ã—Å—Ç—Ä—ã–µ –∫–ª–∏–µ–Ω—Ç—ã */
    .quick-customers {
        margin-top: 20px;
    }

    .quick-customers h5 {
        color: #2c3e50;
        margin-bottom: 12px;
        font-size: 15px;
    }

    .quick-customers-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 12px;
    }

    .quick-customer-card {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 12px;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .quick-customer-card:hover {
        background: white;
        border-color: #667eea;
        transform: translateY(-1px);
        box-shadow: 0 2px 10px rgba(102, 126, 234, 0.1);
    }

    .customer-avatar {
        width: 36px;
        height: 36px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 14px;
    }

    .customer-details {
        flex: 1;
    }

    .customer-name {
        font-weight: 600;
        color: #2c3e50;
        font-size: 14px;
        margin-bottom: 2px;
    }

    .customer-phone {
        font-size: 12px;
        color: #6c757d;
    }

    /* –§–æ—Ä–º–∞ –∫–ª–∏–µ–Ω—Ç–∞ */
    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-bottom: 15px;
    }

    .form-group {
        margin-bottom: 15px;
    }

    .form-label {
        display: block;
        margin-bottom: 6px;
        font-weight: 500;
        color: #2c3e50;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .form-control {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #dee2e6;
        border-radius: 6px;
        font-size: 14px;
        transition: all 0.3s;
    }

    .form-control:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        outline: none;
    }

    .date-input-wrapper {
        position: relative;
    }

    .date-input-wrapper input[type="date"] {
        padding-right: 40px;
    }

    .date-icon {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: #6c757d;
        pointer-events: none;
    }

    .form-help {
        font-size: 12px;
        color: #6c757d;
        margin-top: 4px;
    }

    /* –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–æ–≤ */
    .suggestions-container {
        margin-top: 15px;
    }

    .suggestion-alert {
        padding: 12px 16px;
        border-radius: 8px;
        margin-bottom: 10px;
        border-left: 4px solid;
    }

    .suggestion-alert.info {
        background: #e3f2fd;
        border-left-color: #2196f3;
    }

    .suggestion-alert.warning {
        background: #fff3e0;
        border-left-color: #ff9800;
    }

    .suggestion-buttons {
        display: flex;
        gap: 10px;
        margin-top: 8px;
    }

    /* –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ */
    .booking-right-column {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    /* –î–∞—Ç—ã –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è */
    .selected-dates {
        display: flex;
        justify-content: space-between;
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
    }

    .date-item {
        text-align: center;
    }

    .date-label {
        display: block;
        font-size: 12px;
        color: #6c757d;
        margin-bottom: 4px;
    }

    .date-value {
        font-weight: 600;
        color: #2c3e50;
        font-size: 16px;
    }

    /* –í—ã–±–æ—Ä –Ω–æ–º–µ—Ä–∞ */
    .room-select-wrapper {
        position: relative;
    }

    .select-arrow {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: #6c757d;
        pointer-events: none;
    }

    .available-count {
        margin-top: 8px;
        font-size: 13px;
        color: #28a745;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    /* –†–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ */
    .price-summary {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        padding: 20px;
        border-radius: 8px;
        margin-top: 20px;
    }

    .price-summary h5 {
        color: #2c3e50;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .price-breakdown {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .price-item {
        display: flex;
        justify-content: space-between;
        color: #6c757d;
        font-size: 14px;
    }

    .price-divider {
        height: 1px;
        background: #dee2e6;
        margin: 10px 0;
    }

    .price-total {
        display: flex;
        justify-content: space-between;
        font-size: 18px;
        font-weight: 700;
        color: #2c3e50;
        padding-top: 10px;
        border-top: 2px solid #dee2e6;
    }

    /* –ö–∞—Ä—Ç–æ—á–∫–∏ –Ω–æ–º–µ—Ä–æ–≤ */
    .rooms-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 15px;
        max-height: 400px;
        overflow-y: auto;
        padding: 5px;
    }

    .room-card {
        background: white;
        border: 2px solid #e9ecef;
        border-radius: 10px;
        padding: 15px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .room-card:hover {
        border-color: #667eea;
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .room-card.selected {
        border-color: #4CAF50;
        background: #f8fff8;
    }

    .room-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
    }

    .room-number {
        font-size: 20px;
        font-weight: 700;
        color: #2c3e50;
    }

    .room-price {
        font-weight: 600;
        color: #4CAF50;
        font-size: 14px;
    }

    .room-type {
        font-weight: 600;
        color: #667eea;
        margin-bottom: 10px;
        font-size: 15px;
    }

    .room-details {
        display: flex;
        gap: 15px;
        margin-bottom: 10px;
        font-size: 13px;
        color: #6c757d;
    }

    .room-feature {
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .room-features {
        font-size: 12px;
        color: #5d6d7e;
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .select-room-btn {
        width: 100%;
        padding: 8px;
        background: #667eea;
        color: white;
        border: none;
        border-radius: 6px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
    }

    .select-room-btn:hover {
        background: #5a6fd8;
    }

    /* –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏—è */
    .action-buttons {
        margin-top: 20px;
    }

    .button-group {
        display: flex;
        gap: 15px;
    }

    .btn-create-booking {
        flex: 1;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 15px;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
    }

    .btn-create-booking:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 20px rgba(102, 126, 234, 0.3);
    }

    .btn-cancel {
        padding: 15px 30px;
        background: white;
        color: #667eea;
        border: 2px solid #667eea;
        border-radius: 8px;
        text-decoration: none;
        font-weight: 600;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        transition: all 0.3s ease;
    }

    .btn-cancel:hover {
        background: #667eea;
        color: white;
    }

    /* –°–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö */
    .error-message {
        color: #e74c3c;
        font-size: 13px;
        margin-top: 5px;
        display: flex;
        align-items: center;
        gap: 5px;
        min-height: 20px;
    }

    .error-icon {
        font-size: 12px;
    }

    /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
    @media (max-width: 1200px) {
        .booking-content {
            grid-template-columns: 1fr;
        }

        .date-range-picker {
            flex-direction: column;
            align-items: stretch;
        }

        .date-input-group {
            flex-direction: column;
        }
    }

    @media (max-width: 768px) {
        .form-row {
            grid-template-columns: 1fr;
        }

        .button-group {
            flex-direction: column;
        }

        .switch-buttons {
            flex-direction: column;
        }

        .rooms-grid {
            grid-template-columns: 1fr;
        }

        .quick-customers-grid {
            grid-template-columns: 1fr;
        }
    }
</style>

<script>
    // –¢–∞–π–º–µ—Ä—ã –¥–ª—è –∑–∞–¥–µ—Ä–∂–∫–∏ –ø–æ–∏—Å–∫–∞
    let searchTimeout;
    let lastNameTimeout;
    let phoneTimeout;

    document.addEventListener('DOMContentLoaded', function() {
        const checkInInput = document.getElementById('check_in');
        const checkOutInput = document.getElementById('check_out');
        const roomSelect = document.getElementById('{{ booking_form.room.id_for_label }}');
        const customerSearchInput = document.getElementById('customerSearch');

        // –≠–ª–µ–º–µ–Ω—Ç—ã —Ñ–æ—Ä–º—ã –∫–ª–∏–µ–Ω—Ç–∞
        const firstNameInput = document.getElementById('{{ customer_form.first_name.id_for_label }}');
        const lastNameInput = document.getElementById('{{ customer_form.last_name.id_for_label }}');
        const phoneInput = document.getElementById('{{ customer_form.phone.id_for_label }}');
        const birthdayInput = document.getElementById('{{ customer_form.birthday.id_for_label }}');

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–∏–ø–∞ –∫–ª–∏–µ–Ω—Ç–∞
        updateCustomerType();

        // –ü–æ–∏—Å–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤ –ø—Ä–∏ –≤–≤–æ–¥–µ (–¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö)
        if (customerSearchInput) {
            customerSearchInput.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                currentSearchQuery = this.value.trim();

                if (currentSearchQuery.length >= 2) {
                    searchTimeout = setTimeout(() => {
                        searchCustomers();
                    }, 500);
                } else {
                    hideSearchResults();
                }
            });

            // –ó–∞–∫—Ä—ã—Ç–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –ø–æ–ª—è
            document.addEventListener('click', function(e) {
                const resultsContainer = document.getElementById('customerSearchResults');
                if (!customerSearchInput.contains(e.target) &&
                    !(resultsContainer && resultsContainer.contains(e.target))) {
                    hideSearchResults();
                }
            });
        }

        // –ü–æ–∏—Å–∫ –ø—Ä–∏ –≤–≤–æ–¥–µ —Ñ–∞–º–∏–ª–∏–∏ (–¥–ª—è –Ω–æ–≤–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞)
        if (lastNameInput) {
            lastNameInput.addEventListener('input', function() {
                clearTimeout(lastNameTimeout);
                const lastName = this.value.trim();

                if (lastName.length >= 2 && isNewCustomer()) {
                    lastNameTimeout = setTimeout(() => {
                        searchSimilarCustomers(lastName, 'last_name');
                    }, 500);
                } else {
                    clearSuggestions();
                }
            });
        }

        // –ü–æ–∏—Å–∫ –ø—Ä–∏ –≤–≤–æ–¥–µ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (–¥–ª—è –Ω–æ–≤–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞)
        if (phoneInput) {
            phoneInput.addEventListener('input', function() {
                clearTimeout(phoneTimeout);
                const phone = this.value.trim();

                if (phone.length >= 5 && isNewCustomer()) {
                    phoneTimeout = setTimeout(() => {
                        searchSimilarCustomers(phone, 'phone');
                    }, 500);
                } else {
                    clearSuggestions();
                }
            });
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π –¥–∞—Ç—ã –≤—ã–µ–∑–¥–∞
        if (checkInInput && checkOutInput) {
            checkInInput.addEventListener('change', function() {
                if (checkOutInput) {
                    checkOutInput.min = this.value;
                    if (checkOutInput.value && checkOutInput.value < this.value) {
                        checkOutInput.value = '';
                    }
                }
            });
        }

        // –†–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –Ω–æ–º–µ—Ä–∞
        if (roomSelect) {
            roomSelect.addEventListener('change', calculatePrice);
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞—Å—á–µ—Ç–∞
        calculatePrice();

        // –î–æ–±–∞–≤–ª—è–µ–º data-price –∫ options
        if (roomSelect) {
            document.querySelectorAll('.room-card').forEach(card => {
                const roomId = card.getAttribute('data-room-id');
                const roomPrice = card.getAttribute('data-price');
                const option = roomSelect.querySelector(`option[value="${roomId}"]`);
                if (option) {
                    option.setAttribute('data-price', roomPrice);
                }
            });
        }

        // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–ª–∏–µ–Ω—Ç, –∑–∞–≥—Ä—É–∂–∞–µ–º –µ–≥–æ –¥–∞–Ω–Ω—ã–µ
        const customerId = document.getElementById('selectedCustomerId').value;
        if (customerId && !isNewCustomer()) {
            loadCustomerData(customerId);
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π —Ñ–æ—Ä–º—ã
        const bookingForm = document.getElementById('bookingForm');
        if (bookingForm) {
            bookingForm.addEventListener('submit', function(e) {
                updateHiddenFields();
            });
        }
    });

    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–∏–ø–∞ –∫–ª–∏–µ–Ω—Ç–∞
    function switchCustomerType(type) {
        const existingCustomerSearch = document.getElementById('existingCustomerSearch');
        const customerInfoSection = document.getElementById('customerInfoSection');
        const switchBtns = document.querySelectorAll('.switch-btn');
        const customerOptionInput = document.getElementById('customer_option');
        const hiddenCustomerOption = document.getElementById('hidden_customer_option');

        // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É
        switchBtns.forEach(btn => btn.classList.remove('active'));
        document.querySelector(`.switch-btn[onclick*="${type}"]`).classList.add('active');

        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è
        customerOptionInput.value = type;
        if (hiddenCustomerOption) {
            hiddenCustomerOption.value = type;
        }

        if (type === 'existing') {
            existingCustomerSearch.style.display = 'block';
            customerInfoSection.style.opacity = '0.6';
            customerInfoSection.style.pointerEvents = 'none';
            // –ü—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ –æ—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
            if (!document.getElementById('selectedCustomerId').value) {
                clearCustomerForm();
            }
        } else {
            existingCustomerSearch.style.display = 'none';
            customerInfoSection.style.opacity = '1';
            customerInfoSection.style.pointerEvents = 'auto';
            clearCustomerSelection();
            clearCustomerForm();
        }

        // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
        clearSuggestions();
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–∞ –∫–ª–∏–µ–Ω—Ç–∞
    function isNewCustomer() {
        return document.getElementById('customer_option').value === 'new';
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–∞
    function loadCustomerData(customerId) {
        if (!customerId) return;

        fetch(`/administrator/bookings/get-customer/${customerId}/`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('–ö–ª–∏–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    fillCustomerForm(data.customer);
                    document.getElementById('selectedCustomerId').value = customerId;
                    const hiddenCustomerId = document.getElementById('hidden_customer_id');
                    if (hiddenCustomerId) {
                        hiddenCustomerId.value = customerId;
                    }

                    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª–µ –ø–æ–∏—Å–∫–∞
                    const searchInput = document.getElementById('customerSearch');
                    searchInput.value = `${data.customer.last_name} ${data.customer.first_name}`;

                    hideSearchResults();
                    showNotification(`–ó–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞: ${data.customer.last_name} ${data.customer.first_name}`, 'success');
                } else {
                    showNotification(data.error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–∞', 'error');
                }
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–ª–∏–µ–Ω—Ç–∞:', error);
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–∞', 'error');
            });
    }

    // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã –¥–∞–Ω–Ω—ã–º–∏ –∫–ª–∏–µ–Ω—Ç–∞
    function fillCustomerForm(customer) {
        const firstNameInput = document.getElementById('{{ customer_form.first_name.id_for_label }}');
        const lastNameInput = document.getElementById('{{ customer_form.last_name.id_for_label }}');
        const emailInput = document.getElementById('{{ customer_form.email.id_for_label }}');
        const phoneInput = document.getElementById('{{ customer_form.phone.id_for_label }}');
        const passportInput = document.getElementById('{{ customer_form.passport_number.id_for_label }}');
        const birthdayInput = document.getElementById('{{ customer_form.birthday.id_for_label }}');

        if (firstNameInput) firstNameInput.value = customer.first_name || '';
        if (lastNameInput) lastNameInput.value = customer.last_name || '';
        if (emailInput) emailInput.value = customer.email || '';
        if (phoneInput) phoneInput.value = customer.phone || '';
        if (passportInput) passportInput.value = customer.passport_number || '';

        if (birthdayInput && customer.birthday) {
            birthdayInput.value = customer.birthday;
        }

        // –û—á–∏—â–∞–µ–º –æ—à–∏–±–∫–∏
        clearErrors();
    }

    // –û—á–∏—Å—Ç–∫–∞ —Ñ–æ—Ä–º—ã –∫–ª–∏–µ–Ω—Ç–∞
    function clearCustomerForm() {
        if (isNewCustomer()) {
            const firstNameInput = document.getElementById('{{ customer_form.first_name.id_for_label }}');
            const lastNameInput = document.getElementById('{{ customer_form.last_name.id_for_label }}');
            const emailInput = document.getElementById('{{ customer_form.email.id_for_label }}');
            const phoneInput = document.getElementById('{{ customer_form.phone.id_for_label }}');
            const passportInput = document.getElementById('{{ customer_form.passport_number.id_for_label }}');
            const birthdayInput = document.getElementById('{{ customer_form.birthday.id_for_label }}');

            if (firstNameInput) firstNameInput.value = '';
            if (lastNameInput) lastNameInput.value = '';
            if (emailInput) emailInput.value = '';
            if (phoneInput) phoneInput.value = '';
            if (passportInput) passportInput.value = '';
            if (birthdayInput) birthdayInput.value = '';

            clearErrors();
        }
    }

    // –ü–æ–∏—Å–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤ –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö
    function searchCustomers() {
        const query = document.getElementById('customerSearch').value.trim();
        if (!query) {
            hideSearchResults();
            return;
        }

        fetch(`/administrator/bookings/search-customers/?q=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                showSearchResults(data.results);
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞:', error);
            });
    }

    // –ü–æ–∏—Å–∫ –ø–æ—Ö–æ–∂–∏—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ –¥–ª—è –Ω–æ–≤—ã—Ö
    function searchSimilarCustomers(query, field) {
        if (!query || query.length < 2) return;

        fetch(`/administrator/bookings/search-customers/?q=${encodeURIComponent(query)}&field=${field}`)
            .then(response => response.json())
            .then(data => {
                if (data.results.length > 0) {
                    showCustomerSuggestions(data.results, field);
                }
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞:', error);
            });
    }

    // –ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤
    function showSearchResults(customers) {
        const resultsContainer = document.getElementById('customerSearchResults');
        resultsContainer.innerHTML = '';

        if (customers.length === 0) {
            resultsContainer.innerHTML = `
                <div class="customer-result-item">
                    <div style="text-align: center; color: #999; padding: 20px;">
                        <i class="fas fa-search" style="font-size: 24px; margin-bottom: 10px;"></i>
                        <div>–ö–ª–∏–µ–Ω—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>
                    </div>
                </div>
            `;
        } else {
            customers.forEach(customer => {
                const item = document.createElement('div');
                item.className = 'customer-result-item';
                item.innerHTML = `
                    <div class="customer-result-name">
                        <i class="fas fa-user-circle" style="margin-right: 8px;"></i>
                        ${customer.last_name} ${customer.first_name}
                    </div>
                    <div class="customer-result-info">
                        <span><i class="fas fa-phone"></i> ${customer.phone}</span>
                        <span><i class="fas fa-envelope"></i> ${customer.email || '-'}</span>
                    </div>
                `;
                item.onclick = () => loadCustomerData(customer.id);
                resultsContainer.appendChild(item);
            });
        }

        resultsContainer.style.display = 'block';
    }

    // –ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –¥–ª—è –Ω–æ–≤—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤
    function showCustomerSuggestions(customers, field) {
        const suggestionsContainer = document.getElementById('customerSuggestions');
        suggestionsContainer.innerHTML = '';

        if (customers.length === 0) return;

        let title = '';
        let alertClass = '';

        if (field === 'last_name') {
            title = '–ù–∞–π–¥–µ–Ω—ã –∫–ª–∏–µ–Ω—Ç—ã —Å –ø–æ—Ö–æ–∂–µ–π —Ñ–∞–º–∏–ª–∏–µ–π:';
            alertClass = 'warning';
        } else if (field === 'phone') {
            title = '–í–æ–∑–º–æ–∂–Ω–æ, —ç—Ç–æ—Ç –∫–ª–∏–µ–Ω—Ç —É–∂–µ –µ—Å—Ç—å –≤ –±–∞–∑–µ:';
            alertClass = 'info';
        } else if (field === 'email') {
            title = '–ù–∞–π–¥–µ–Ω –∫–ª–∏–µ–Ω—Ç —Å —Ç–∞–∫–∏–º email:';
            alertClass = 'info';
        }

        const alertDiv = document.createElement('div');
        alertDiv.className = `suggestion-alert ${alertClass}`;

        let html = `<strong><i class="fas fa-info-circle"></i> ${title}</strong><br><br>`;

        customers.slice(0, 3).forEach(customer => {
            html += `
                <div style="margin-bottom: 8px; padding: 8px; background: rgba(255,255,255,0.5); border-radius: 4px;">
                    <strong>${customer.last_name} ${customer.first_name}</strong><br>
                    <small>üì± ${customer.phone} | ‚úâ ${customer.email || '-'}</small>
                </div>
            `;
        });

        html += `
            <div class="suggestion-buttons">
                <button type="button" class="btn btn-sm btn-outline-primary"
                        onclick="useExistingCustomer(${customers[0].id})">
                    <i class="fas fa-check"></i> –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
                </button>
                <button type="button" class="btn btn-sm btn-outline-secondary"
                        onclick="clearSuggestions()">
                    <i class="fas fa-times"></i> –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∫–∞–∫ –Ω–æ–≤–æ–≥–æ
                </button>
            </div>
        `;

        alertDiv.innerHTML = html;
        suggestionsContainer.appendChild(alertDiv);
    }

    // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
    function useExistingCustomer(customerId) {
        switchCustomerType('existing');
        loadCustomerData(customerId);
        clearSuggestions();
    }

    // –û—á–∏—Å—Ç–∏—Ç—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
    function clearSuggestions() {
        const suggestionsContainer = document.getElementById('customerSuggestions');
        suggestionsContainer.innerHTML = '';
    }

    // –°–∫—Ä—ã—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞
    function hideSearchResults() {
        const resultsContainer = document.getElementById('customerSearchResults');
        if (resultsContainer) {
            resultsContainer.style.display = 'none';
        }
    }

    // –û—á–∏—Å—Ç–∏—Ç—å –≤—ã–±–æ—Ä –∫–ª–∏–µ–Ω—Ç–∞
    function clearCustomerSelection() {
        document.getElementById('selectedCustomerId').value = '';
        const hiddenCustomerId = document.getElementById('hidden_customer_id');
        if (hiddenCustomerId) {
            hiddenCustomerId.value = '';
        }
        const searchInput = document.getElementById('customerSearch');
        if (searchInput) searchInput.value = '';
        hideSearchResults();
    }

    // –û—á–∏—Å—Ç–∏—Ç—å –æ—à–∏–±–∫–∏
    function clearErrors() {
        const errorElements = document.querySelectorAll('.error-message');
        errorElements.forEach(el => el.innerHTML = '');
    }

    // –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    function showNotification(message, type) {
        // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        const oldNotifications = document.querySelectorAll('.notification-toast');
        oldNotifications.forEach(n => n.remove());

        const notification = document.createElement('div');
        notification.className = `notification-toast notification-${type}`;
        notification.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
            ${message}
            <button onclick="this.parentElement.remove()" style="background: none; border: none; color: inherit; margin-left: auto;">
                <i class="fas fa-times"></i>
            </button>
        `;

        document.body.appendChild(notification);

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–∫—Ä—ã—Ç–∏–µ
        setTimeout(() => {
            if (notification.parentElement) {
                notification.remove();
            }
        }, 5000);
    }

    // –†–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏
    function calculatePrice() {
        const roomSelect = document.getElementById('{{ booking_form.room.id_for_label }}');
        const checkIn = '{{ check_in_date }}';
        const checkOut = '{{ check_out_date }}';
        const nightsCount = document.getElementById('nights-count');
        const nightsDisplay = document.getElementById('nights-display');
        const pricePerNight = document.getElementById('price-per-night');
        const totalPrice = document.getElementById('total-price');

        if (!checkIn || !checkOut || !roomSelect.value) {
            nightsCount.textContent = '0';
            nightsDisplay.textContent = '0';
            pricePerNight.textContent = '0 —Ä—É–±.';
            totalPrice.textContent = '0 —Ä—É–±.';
            return;
        }

        const start = new Date(checkIn);
        const end = new Date(checkOut);
        const nights = Math.ceil((end - start) / (1000 * 60 * 60 * 24));

        const selectedOption = roomSelect.options[roomSelect.selectedIndex];
        const roomPrice = selectedOption.getAttribute('data-price') || '0';

        const total = nights * parseFloat(roomPrice);

        nightsCount.textContent = nights;
        nightsDisplay.textContent = nights;
        pricePerNight.textContent = parseFloat(roomPrice).toFixed(2) + ' —Ä—É–±.';
        totalPrice.textContent = total.toFixed(2) + ' —Ä—É–±.';
    }

    // –í—ã–±–æ—Ä –Ω–æ–º–µ—Ä–∞
    function selectRoom(roomId) {
        const roomSelect = document.getElementById('{{ booking_form.room.id_for_label }}');
        roomSelect.value = roomId;

        // –°–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å–æ –≤—Å–µ—Ö –∫–∞—Ä—Ç–æ—á–µ–∫
        document.querySelectorAll('.room-card').forEach(card => {
            card.classList.remove('selected');
        });

        // –í—ã–¥–µ–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –∫–∞—Ä—Ç–æ—á–∫—É
        const selectedCard = document.querySelector(`[data-room-id="${roomId}"]`);
        if (selectedCard) {
            selectedCard.classList.add('selected');
        }

        // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ç–æ–∏–º–æ—Å—Ç—å
        calculatePrice();

        // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ —Ä–∞—Å—á–µ—Ç—É
        const priceSummary = document.querySelector('.price-summary');
        if (priceSummary) {
            priceSummary.scrollIntoView({
                behavior: 'smooth',
                block: 'center'
            });
        }
    }

    // –û–±–Ω–æ–≤–∏—Ç—å —Å–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
    function updateHiddenFields() {
        const customerOption = document.getElementById('customer_option').value;
        const hiddenCustomerOption = document.getElementById('hidden_customer_option');
        if (hiddenCustomerOption) {
            hiddenCustomerOption.value = customerOption;
        }

        const customerId = document.getElementById('selectedCustomerId').value;
        const hiddenCustomerId = document.getElementById('hidden_customer_id');
        if (hiddenCustomerId) {
            hiddenCustomerId.value = customerId;
        }

        // –î–æ–±–∞–≤–ª—è–µ–º —Å–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ check_in_date –∏ check_out_date
        const checkInDateInput = document.getElementById('id_check_in_date');
        const checkOutDateInput = document.getElementById('id_check_out_date');
        if (checkInDateInput && checkOutDateInput) {
            // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –æ–Ω–∏ –µ—Å—Ç—å –≤ —Ñ–æ—Ä–º–µ
            if (!document.querySelector('input[name="check_in_date"]')) {
                const hiddenCheckIn = document.createElement('input');
                hiddenCheckIn.type = 'hidden';
                hiddenCheckIn.name = 'check_in_date';
                hiddenCheckIn.value = checkInDateInput.value;
                document.getElementById('bookingForm').appendChild(hiddenCheckIn);
            }
            if (!document.querySelector('input[name="check_out_date"]')) {
                const hiddenCheckOut = document.createElement('input');
                hiddenCheckOut.type = 'hidden';
                hiddenCheckOut.name = 'check_out_date';
                hiddenCheckOut.value = checkOutDateInput.value;
                document.getElementById('bookingForm').appendChild(hiddenCheckOut);
            }
        }
    }

    // –û–±–Ω–æ–≤–∏—Ç—å —Ç–∏–ø –∫–ª–∏–µ–Ω—Ç–∞
    function updateCustomerType() {
        const customerOption = '{% if new_customer %}new{% else %}existing{% endif %}';
        switchCustomerType(customerOption);
    }
</script>

<style>
    /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π */
    .notification-toast {
        position: fixed;
        top: 20px;
        right: 20px;
        background: white;
        border-radius: 8px;
        padding: 15px 20px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        display: flex;
        align-items: center;
        gap: 12px;
        z-index: 9999;
        animation: slideIn 0.3s ease;
        max-width: 400px;
    }

    .notification-success {
        border-left: 4px solid #4CAF50;
        background: #f8fff8;
    }

    .notification-error {
        border-left: 4px solid #dc3545;
        background: #fff8f8;
    }

    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –ø–æ–ª–µ–π */
    .is-valid {
        border-color: #28a745 !important;
    }

    .is-invalid {
        border-color: #dc3545 !important;
    }
</style>
{% endblock %}