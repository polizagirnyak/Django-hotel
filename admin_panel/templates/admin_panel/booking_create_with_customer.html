{% extends 'admin_panel/base.html' %}
{% load static %}
 
{% block content %}
<div class="form-container">
    <div class="form-header">
        <h1>–ù–æ–≤–æ–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</h1>
        <p class="form-subtitle">–°–æ–∑–¥–∞–Ω–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Å –≤—ã–±–æ—Ä–æ–º —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –Ω–æ–º–µ—Ä–∞ –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –∫–ª–∏–µ–Ω—Ç–µ</p>
    </div>
 
    <!-- –§–æ—Ä–º–∞ –ø–æ–∏—Å–∫–∞ —Å–≤–æ–±–æ–¥–Ω—ã—Ö –Ω–æ–º–µ—Ä–æ–≤ -->
    <div class="search-card">
        <h3>üìÖ –ü–æ–∏—Å–∫ —Å–≤–æ–±–æ–¥–Ω—ã—Ö –Ω–æ–º–µ—Ä–æ–≤</h3>
        <form method="get" class="search-form">
            <div class="form-grid">
                <div class="form-group">
                    <label for="check_in" class="form-label">–î–∞—Ç–∞ –∑–∞–µ–∑–¥–∞ *</label>
                    <input type="date" name="check_in" id="check_in" class="form-control"
                           value="{{ check_in_date|default:'' }}" required
                           min="{{ today|date:'Y-m-d' }}">
                </div>
                <div class="form-group">
                    <label for="check_out" class="form-label">–î–∞—Ç–∞ –≤—ã–µ–∑–¥–∞ *</label>
                    <input type="date" name="check_out" id="check_out" class="form-control"
                           value="{{ check_out_date|default:'' }}" required
                           min="{{ today|date:'Y-m-d' }}">
                </div>
            </div>
            <button type="submit" class="btn btn-primary">
                üîç –ù–∞–π—Ç–∏ —Å–≤–æ–±–æ–¥–Ω—ã–µ –Ω–æ–º–µ—Ä–∞
            </button>
        </form>
    </div>
 
    {% if check_in_date and check_out_date %}
    <form method="post" class="booking-form">
        {% csrf_token %}
 
        <div class="form-columns">
            <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª–∏–µ–Ω—Ç–µ -->
            <div class="form-column">
                <div class="form-section">
                    <h3>üë§ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª–∏–µ–Ω—Ç–µ</h3>
 
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="{{ customer_form.first_name.id_for_label }}" class="form-label">
                                –ò–º—è *
                            </label>
                            {{ customer_form.first_name }}
                            {% if customer_form.first_name.errors %}
                            <div class="error-message">
                                {% for error in customer_form.first_name.errors %}
                                <span class="error-icon">‚ö†</span> {{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
 
                        <div class="form-group">
                            <label for="{{ customer_form.last_name.id_for_label }}" class="form-label">
                                –§–∞–º–∏–ª–∏—è *
                            </label>
                            {{ customer_form.last_name }}
                            {% if customer_form.last_name.errors %}
                            <div class="error-message">
                                {% for error in customer_form.last_name.errors %}
                                <span class="error-icon">‚ö†</span> {{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                    </div>
 
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="{{ customer_form.email.id_for_label }}" class="form-label">
                                Email *
                            </label>
                            {{ customer_form.email }}
                            {% if customer_form.email.errors %}
                            <div class="error-message">
                                {% for error in customer_form.email.errors %}
                                <span class="error-icon">‚ö†</span> {{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
 
                        <div class="form-group">
                            <label for="{{ customer_form.phone.id_for_label }}" class="form-label">
                                –¢–µ–ª–µ—Ñ–æ–Ω *
                            </label>
                            {{ customer_form.phone }}
                            {% if customer_form.phone.errors %}
                            <div class="error-message">
                                {% for error in customer_form.phone.errors %}
                                <span class="error-icon">‚ö†</span> {{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                    </div>
 
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="{{ customer_form.passport_number.id_for_label }}" class="form-label">
                                –ü–∞—Å–ø–æ—Ä—Ç *
                            </label>
                            {{ customer_form.passport_number }}
                            {% if customer_form.passport_number.errors %}
                            <div class="error-message">
                                {% for error in customer_form.passport_number.errors %}
                                <span class="error-icon">‚ö†</span> {{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
 
                        <div class="form-group">
                            <label for="{{ customer_form.birthday.id_for_label }}" class="form-label">
                                –î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è *
                            </label>
                            {{ customer_form.birthday }}
                            {% if customer_form.birthday.errors %}
                            <div class="error-message">
                                {% for error in customer_form.birthday.errors %}
                                <span class="error-icon">‚ö†</span> {{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
 
            <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏ -->
            <div class="form-column">
                <div class="form-section">
                    <h3>üè® –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏</h3>
 
                    <!-- –î–∞—Ç—ã –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è -->
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="{{ booking_form.check_in_date.id_for_label }}" class="form-label">
                                –î–∞—Ç–∞ –∑–∞–µ–∑–¥–∞ *
                            </label>
                            <input type="date" name="check_in_date" id="id_check_in_date"
                                   class="form-control" value="{{ check_in_date }}" readonly>
                        </div>
 
                        <div class="form-group">
                            <label for="{{ booking_form.check_out_date.id_for_label }}" class="form-label">
                                –î–∞—Ç–∞ –≤—ã–µ–∑–¥–∞ *
                            </label>
                            <input type="date" name="check_out_date" id="id_check_out_date"
                                   class="form-control" value="{{ check_out_date }}" readonly>
                        </div>
                    </div>
 
                    <!-- –í—ã–±–æ—Ä –Ω–æ–º–µ—Ä–∞ -->
                    <div class="form-group">
                        <label for="{{ booking_form.room.id_for_label }}" class="form-label">
                            –í—ã–±–µ—Ä–∏—Ç–µ –Ω–æ–º–µ—Ä *
                        </label>
                        {{ booking_form.room }}
                        {% if booking_form.room.errors %}
                        <div class="error-message">
                            {% for error in booking_form.room.errors %}
                            <span class="error-icon">‚ö†</span> {{ error }}
                            {% endfor %}
                        </div>
                        {% endif %}
 
                        {% if available_rooms %}
                            <div class="available-rooms-info">
                                <small>–ù–∞–π–¥–µ–Ω–æ —Å–≤–æ–±–æ–¥–Ω—ã—Ö –Ω–æ–º–µ—Ä–æ–≤: {{ available_rooms.count }}</small>
                            </div>
                        {% endif %}
                    </div>
 
                    <!-- –û—Å–æ–±—ã–µ –ø–æ–∂–µ–ª–∞–Ω–∏—è -->
                    <div class="form-group">
                        <label for="{{ booking_form.special_requests.id_for_label }}" class="form-label">
                            –û—Å–æ–±—ã–µ –ø–æ–∂–µ–ª–∞–Ω–∏—è
                        </label>
                        {{ booking_form.special_requests }}
                    </div>
 
                    <!-- –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç -->
                    <div class="price-calculation">
                        <h4>üí∞ –†–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏</h4>
                        <div class="price-details">
                            <div class="price-row">
                                <span>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–æ—á–µ–π:</span>
                                <span id="nights-count">0</span>
                            </div>
                            <div class="price-row">
                                <span>–¶–µ–Ω–∞ –∑–∞ –Ω–æ—á—å:</span>
                                <span id="price-per-night">0 —Ä—É–±.</span>
                            </div>
                            <div class="price-row total">
                                <strong>–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å:</strong>
                                <strong id="total-price">0 —Ä—É–±.</strong>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
 
        <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏—è -->
        <div class="form-actions">
            <button type="submit" class="btn btn-primary">
                <span class="btn-icon">‚úì</span>
                –°–æ–∑–¥–∞—Ç—å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
            </button>
            <a href="{% url 'rooms_dashboard' %}" class="btn btn-secondary">
                <span class="btn-icon">‚Üê</span>
                –û—Ç–º–µ–Ω–∞
            </a>
        </div>
    </form>
    {% endif %}
 
    <!-- –°–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –Ω–æ–º–µ—Ä–æ–≤ -->
    {% if available_rooms %}
    <div class="available-rooms-section">
        <h3>üõèÔ∏è –î–æ—Å—Ç—É–ø–Ω—ã–µ –Ω–æ–º–µ—Ä–∞</h3>
        <div class="rooms-grid">
            {% for room in available_rooms %}
            <div class="room-card" data-room-id="{{ room.id }}" data-price="{{ room.room_type.price_per_night }}">
                <div class="room-header">
                    <span class="room-number">{{ room.room_number }}</span>
                    <span class="room-price">{{ room.room_type.price_per_night }} —Ä—É–±./–Ω–æ—á—å</span>
                </div>
                <div class="room-type">{{ room.room_type.name }}</div>
                <div class="room-details">
                    <span class="room-capacity">üë• {{ room.room_type.capacity }} —á–µ–ª.</span>
                    <span class="room-floor">üè¢ {{ room.floor }} —ç—Ç–∞–∂</span>
                </div>
                {% if room.features %}
                <div class="room-features">
                    <strong>–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:</strong> {{ room.features }}
                </div>
                {% endif %}
                <button type="button" class="select-room-btn" onclick="selectRoom({{ room.id }})">
                    –í—ã–±—Ä–∞—Ç—å —ç—Ç–æ—Ç –Ω–æ–º–µ—Ä
                </button>
            </div>
            {% empty %}
            <div class="no-rooms">
                <p>–ù–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –¥–∞—Ç—ã —Å–≤–æ–±–æ–¥–Ω—ã—Ö –Ω–æ–º–µ—Ä–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.</p>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>
 
<style>
    /* –û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ */
    .form-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2rem 1rem;
    }
 
    .form-header {
        text-align: center;
        margin-bottom: 2rem;
    }
 
    .form-header h1 {
        color: #2c3e50;
        font-size: 2.25rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }
 
    .form-subtitle {
        color: #7f8c8d;
        font-size: 1.1rem;
        margin: 0;
    }
 
    /* –ö–∞—Ä—Ç–æ—á–∫–∞ –ø–æ–∏—Å–∫–∞ */
    .search-card {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        margin-bottom: 2rem;
        border-left: 4px solid #667eea;
    }
 
    .search-card h3 {
        color: #2c3e50;
        margin-bottom: 1rem;
    }
 
    /* –ö–æ–ª–æ–Ω–∫–∏ —Ñ–æ—Ä–º—ã */
    .form-columns {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
        margin-bottom: 2rem;
    }
 
    .form-section {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        height: fit-content;
    }
 
    .form-section h3 {
        color: #2c3e50;
        margin-bottom: 1.5rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid #f1f3f4;
    }
 
    /* –°–µ—Ç–∫–∞ —Ñ–æ—Ä–º—ã */
    .form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        margin-bottom: 1rem;
    }
 
    .form-group {
        margin-bottom: 1rem;
    }
 
    .form-label {
        color: #2c3e50;
        font-weight: 600;
        margin-bottom: 0.5rem;
        display: block;
        font-size: 0.9rem;
    }
 
    /* –ü–æ–ª—è –≤–≤–æ–¥–∞ */
    .form-control {
        width: 100%;
        padding: 0.75rem;
        border: 2px solid #e9ecef;
        border-radius: 6px;
        font-size: 1rem;
        transition: all 0.3s ease;
        box-sizing: border-box;
    }
 
    .form-control:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
 
    /* –†–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ */
    .price-calculation {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1rem;
        margin-top: 1rem;
    }
 
    .price-calculation h4 {
        color: #2c3e50;
        margin-bottom: 1rem;
    }
 
    .price-details {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }
 
    .price-row {
        display: flex;
        justify-content: space-between;
        padding: 0.25rem 0;
    }
 
    .price-row.total {
        border-top: 1px solid #dee2e6;
        padding-top: 0.75rem;
        margin-top: 0.5rem;
        font-size: 1.1rem;
        color: #2c3e50;
    }
 
    /* –°–µ—Ç–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –Ω–æ–º–µ—Ä–æ–≤ */
    .available-rooms-section {
        margin-top: 2rem;
    }
 
    .rooms-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
    }
 
    .room-card {
        background: white;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        padding: 1rem;
        transition: all 0.3s ease;
    }
 
    .room-card:hover {
        border-color: #667eea;
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }
 
    .room-card.selected {
        border-color: #4CAF50;
        background: #f8fff8;
    }
 
    .room-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
    }
 
    .room-number {
        font-size: 1.25rem;
        font-weight: 700;
        color: #2c3e50;
    }
 
    .room-price {
        font-weight: 600;
        color: #4CAF50;
    }
 
    .room-type {
        font-weight: 600;
        color: #667eea;
        margin-bottom: 0.5rem;
    }
 
    .room-details {
        display: flex;
        gap: 1rem;
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
        color: #6c757d;
    }
 
    .room-features {
        font-size: 0.85rem;
        color: #5d6d7e;
        margin-bottom: 1rem;
    }
 
    .select-room-btn {
        width: 100%;
        padding: 0.5rem;
        background: #667eea;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.3s ease;
    }
 
    .select-room-btn:hover {
        background: #5a6fd8;
    }
 
    /* –ö–Ω–æ–ø–∫–∏ */
    .btn {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 6px;
        font-size: 1rem;
        font-weight: 600;
        text-decoration: none;
        text-align: center;
        transition: all 0.3s ease;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }
 
    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }
 
    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }
 
    .btn-secondary {
        background: white;
        color: #667eea;
        border: 2px solid #667eea;
    }
 
    .btn-secondary:hover {
        background: #667eea;
        color: white;
    }
 
    .form-actions {
        display: flex;
        gap: 1rem;
        justify-content: center;
        margin-top: 2rem;
    }
 
    /* –°–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö */
    .error-message {
        color: #e74c3c;
        font-size: 0.85rem;
        margin-top: 0.25rem;
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }
 
    .error-icon {
        font-size: 0.8rem;
    }
 
    /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
    @media (max-width: 768px) {
        .form-columns {
            grid-template-columns: 1fr;
            gap: 1rem;
        }
 
        .form-grid {
            grid-template-columns: 1fr;
        }
 
        .rooms-grid {
            grid-template-columns: 1fr;
        }
 
        .form-actions {
            flex-direction: column;
        }
    }
</style>
 
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const checkInInput = document.getElementById('check_in');
        const checkOutInput = document.getElementById('check_out');
        const roomSelect = document.getElementById('{{ booking_form.room.id_for_label }}');
 
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π –¥–∞—Ç—ã –≤—ã–µ–∑–¥–∞
        if (checkInInput) {
            checkInInput.addEventListener('change', function() {
                if (checkOutInput) {
                    checkOutInput.min = this.value;
                    if (checkOutInput.value && checkOutInput.value < this.value) {
                        checkOutInput.value = '';
                    }
                }
            });
        }
 
        // –†–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –Ω–æ–º–µ—Ä–∞
        if (roomSelect) {
            roomSelect.addEventListener('change', calculatePrice);
        }
 
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞—Å—á–µ—Ç–∞
        calculatePrice();
    });
 
    function calculatePrice() {
        const roomSelect = document.getElementById('{{ booking_form.room.id_for_label }}');
        const checkIn = document.getElementById('id_check_in_date').value;
        const checkOut = document.getElementById('id_check_out_date').value;
        const nightsCount = document.getElementById('nights-count');
        const pricePerNight = document.getElementById('price-per-night');
        const totalPrice = document.getElementById('total-price');
 
        if (!checkIn || !checkOut || !roomSelect.value) {
            nightsCount.textContent = '0';
            pricePerNight.textContent = '0 —Ä—É–±.';
            totalPrice.textContent = '0 —Ä—É–±.';
            return;
        }
 
        const start = new Date(checkIn);
        const end = new Date(checkOut);
        const nights = Math.ceil((end - start) / (1000 * 60 * 60 * 24));
 
        // –ü–æ–ª—É—á–∞–µ–º —Ü–µ–Ω—É –∏–∑ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ option
        const selectedOption = roomSelect.options[roomSelect.selectedIndex];
        const roomPrice = selectedOption.getAttribute('data-price') || '0';
 
        const total = nights * parseFloat(roomPrice);
 
        nightsCount.textContent = nights;
        pricePerNight.textContent = roomPrice + ' —Ä—É–±.';
        totalPrice.textContent = total.toFixed(2) + ' —Ä—É–±.';
    }
 
    function selectRoom(roomId) {
        const roomSelect = document.getElementById('{{ booking_form.room.id_for_label }}');
        roomSelect.value = roomId;
 
        // –°–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å–æ –≤—Å–µ—Ö –∫–∞—Ä—Ç–æ—á–µ–∫
        document.querySelectorAll('.room-card').forEach(card => {
            card.classList.remove('selected');
        });
 
        // –í—ã–¥–µ–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –∫–∞—Ä—Ç–æ—á–∫—É
        const selectedCard = document.querySelector(`[data-room-id="${roomId}"]`);
        if (selectedCard) {
            selectedCard.classList.add('selected');
        }
 
        // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ç–æ–∏–º–æ—Å—Ç—å
        calculatePrice();
 
        // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ —Ñ–æ—Ä–º–µ
        document.querySelector('.booking-form').scrollIntoView({
            behavior: 'smooth'
        });
    }
 
    // –î–æ–±–∞–≤–ª—è–µ–º data-price –∫ options –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    document.addEventListener('DOMContentLoaded', function() {
        const roomSelect = document.getElementById('{{ booking_form.room.id_for_label }}');
        if (roomSelect) {
            // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –Ω–æ–º–µ—Ä–æ–≤ –∏ –¥–æ–±–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ select
            document.querySelectorAll('.room-card').forEach(card => {
                const roomId = card.getAttribute('data-room-id');
                const roomPrice = card.getAttribute('data-price');
                const option = roomSelect.querySelector(`option[value="${roomId}"]`);
                if (option) {
                    option.setAttribute('data-price', roomPrice);
                }
            });
        }
    });
</script>
{% endblock %}